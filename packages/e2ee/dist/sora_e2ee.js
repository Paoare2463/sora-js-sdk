/**
 * @sora/e2ee
 * undefined
 * @version: 2020.5.0-canary.0-dev
 * @author: Shiguredo Inc.
 * @license: Apache-2.0
 **/

(function (global, factory) {
  typeof exports === 'object' && typeof module !== 'undefined' ? module.exports = factory() :
  typeof define === 'function' && define.amd ? define(factory) :
  (global = typeof globalThis !== 'undefined' ? globalThis : global || self, global.SoraE2EE = factory());
}(this, (function () { 'use strict';

  class SoraE2EE {
      constructor() {
          // 対応しているかどうかの判断
          // @ts-ignore トライアル段階の API なので無視する
          const supportsInsertableStreams = !!RTCRtpSender.prototype.createEncodedStreams;
          if (!supportsInsertableStreams) {
              throw new Error("E2EE is not supported in this browser.");
          }
          this.worker = null;
          this.onWorkerDisconnect = null;
      }
      // worker を起動する
      startWorker() {
          // ワーカーを起動する
          const workerScript = atob("InVzZSBzdHJpY3QiOwovKiBlc2xpbnQtZGlzYWJsZSBAdHlwZXNjcmlwdC1lc2xpbnQvbm8tdW51c2VkLXZhcnMgKi8KY29uc3QgY29ubmVjdGlvbklkTGVuZ3RoID0gMjY7CmZ1bmN0aW9uIGJ5dGVDb3VudChuKSB7CiAgICBpZiAobiA9PSAwKSB7CiAgICAgICAgcmV0dXJuIDE7CiAgICB9CiAgICAvLyBsb2cyNTYoeCkgPSBsb2coeCkgLyBsb2coMjU2KQogICAgcmV0dXJuIE1hdGguZmxvb3IoTWF0aC5sb2cobikgLyBNYXRoLmxvZygyICoqIDgpICsgMSk7Cn0KZnVuY3Rpb24gYXJyYXlCdWZmZXJUb051bWJlcihhcnJheUJ1ZmZlcikgewogICAgLy8gMzJiaXQg44G+44Gn44KS5oOz5a6aIChCaWdJbnQg44G444Gu5pu444GN5o+b44GI5pmC44Gr6KaB5L+u5q2jKQogICAgY29uc3QgbmV3QXJyYXlCdWZmZXIgPSBuZXcgQXJyYXlCdWZmZXIoVWludDMyQXJyYXkuQllURVNfUEVSX0VMRU1FTlQpOwogICAgY29uc3QgbmV3RGF0YVZpZXcgPSBuZXcgRGF0YVZpZXcobmV3QXJyYXlCdWZmZXIpOwogICAgY29uc3QgZGF0YVZpZXcgPSBuZXcgRGF0YVZpZXcoYXJyYXlCdWZmZXIpOwogICAgY29uc3QgcGFkZGluZ0xlbmd0aCA9IFVpbnQzMkFycmF5LkJZVEVTX1BFUl9FTEVNRU5UIC0gZGF0YVZpZXcuYnl0ZUxlbmd0aDsKICAgIGZvciAobGV0IGkgPSAwOyBpIDwgcGFkZGluZ0xlbmd0aDsgaSArPSAxKSB7CiAgICAgICAgbmV3RGF0YVZpZXcuc2V0VWludDgoaSwgMCk7CiAgICB9CiAgICBmb3IgKGxldCBpID0gcGFkZGluZ0xlbmd0aCwgaiA9IDA7IGkgPCBVaW50MzJBcnJheS5CWVRFU19QRVJfRUxFTUVOVDsgaSArPSAxLCBqICs9IDEpIHsKICAgICAgICBuZXdEYXRhVmlldy5zZXRVaW50OChpLCBkYXRhVmlldy5nZXRVaW50OChqKSk7CiAgICB9CiAgICByZXR1cm4gbmV3RGF0YVZpZXcuZ2V0VWludDMyKDApOwp9CmZ1bmN0aW9uIGVuY29kZVNGcmFtZUhlYWRlcihzLCBjb3VudCwga2V5SWQpIHsKICAgIC8vICAwIDEgMiAzIDQgNSA2IDcKICAgIC8vICstKy0rLSstKy0rLSstKy0rLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tKy0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLSsKICAgIC8vIHxTfExFTiAgfDF8S0xFTiB8ICAgS0lELi4uIChsZW5ndGg9S0xFTikgICAgfCAgICBDVFIuLi4gKGxlbmd0aD1MRU4pICAgIHwKICAgIC8vICstKy0rLSstKy0rLSstKy0rLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tKy0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLSsKICAgIC8vIFM6IDEgYml0CiAgICAvLyBMRU46IDMgYml0CiAgICAvLyBYOiAxIGJpdAogICAgLy8gS0xFTjogMyBiaXQKICAgIC8vIEtJRDogS0xFTiBieXRlCiAgICAvLyBDVFI6IExFTiBieXRlCiAgICAvLyBUT0RPOiBrZXlJZCAoS0lEKSDjgYwgTnVtYmVyLk1BWF9TQUZFX0lOVEVHRVIsIDcgYnl0ZSDjgpLotoXjgYjjgabjgYTjgZ/loLTlkIjjga/jgqjjg6njg7zjgYvkvovlpJYKICAgIC8vIFRPRE86IGNvdW50IChDVFIpIOOBjCBOdW1iZXIuTUFYX1NBRkVfSU5URUdFUiwgNyBieXRlIOOCkui2heOBiOOBpuOBhOOBn+WgtOWQiOOBr+OCqOODqeODvOOBi+S+i+WklgogICAgaWYgKG1heEtleUlkIDwga2V5SWQgfHwgbWF4Q291bnQgPCBjb3VudCkgewogICAgICAgIHRocm93IG5ldyBFcnJvcigiRVhDRUVERUQtTUFYSU1VTS1CUk9BRENBU1RJTkctVElNRSIpOwogICAgfQogICAgY29uc3Qga2xlbiA9IGJ5dGVDb3VudChrZXlJZCk7CiAgICBjb25zdCBsZW4gPSBieXRlQ291bnQoY291bnQpOwogICAgY29uc3QgaGVhZGVyQnVmZmVyID0gbmV3IEFycmF5QnVmZmVyKDEgKyBrbGVuICsgbGVuKTsKICAgIGNvbnN0IGhlYWRlckRhdGFWaWV3ID0gbmV3IERhdGFWaWV3KGhlYWRlckJ1ZmZlcik7CiAgICAvLyBTLCBMRU4sIDEsIEtMRU4g44GnIDEgYnl0ZQogICAgaGVhZGVyRGF0YVZpZXcuc2V0VWludDgoMCwgKHMgPDwgNykgKyAobGVuIDw8IDQpICsgKDEgPDwgMykgKyBrbGVuKTsKICAgIGNvbnN0IGhlYWRlclVpbnQ4QXJyYXkgPSBuZXcgVWludDhBcnJheShoZWFkZXJCdWZmZXIpOwogICAgY29uc3Qga2V5SWRCdWZmZXIgPSBuZXcgQXJyYXlCdWZmZXIoVWludDMyQXJyYXkuQllURVNfUEVSX0VMRU1FTlQpOwogICAgY29uc3Qga2V5SWREYXRhVmlldyA9IG5ldyBEYXRhVmlldyhrZXlJZEJ1ZmZlcik7CiAgICBrZXlJZERhdGFWaWV3LnNldFVpbnQzMigwLCBrZXlJZCk7CiAgICBjb25zdCBrZXlJZFVpbnQ4QXJyYXkgPSBuZXcgVWludDhBcnJheShrZXlJZEJ1ZmZlcik7CiAgICBoZWFkZXJVaW50OEFycmF5LnNldChrZXlJZFVpbnQ4QXJyYXkuc3ViYXJyYXkoVWludDMyQXJyYXkuQllURVNfUEVSX0VMRU1FTlQgLSBrbGVuKSwgMSk7CiAgICBjb25zdCBjb3VudEJ1ZmZlciA9IG5ldyBBcnJheUJ1ZmZlcihVaW50MzJBcnJheS5CWVRFU19QRVJfRUxFTUVOVCk7CiAgICBjb25zdCBjb3VudERhdGFWaWV3ID0gbmV3IERhdGFWaWV3KGNvdW50QnVmZmVyKTsKICAgIGNvdW50RGF0YVZpZXcuc2V0VWludDMyKDAsIGNvdW50KTsKICAgIGNvbnN0IGNvdW50VWludDhBcnJheSA9IG5ldyBVaW50OEFycmF5KGNvdW50QnVmZmVyKTsKICAgIGhlYWRlclVpbnQ4QXJyYXkuc2V0KGNvdW50VWludDhBcnJheS5zdWJhcnJheShVaW50MzJBcnJheS5CWVRFU19QRVJfRUxFTUVOVCAtIGxlbiksIGtsZW4gKyAxKTsKICAgIHJldHVybiBoZWFkZXJVaW50OEFycmF5Owp9CmZ1bmN0aW9uIHNwbGl0SGVhZGVyKHNmcmFtZSkgewogICAgY29uc3Qgc2ZyYW1lRGF0YVZpZXcgPSBuZXcgRGF0YVZpZXcoc2ZyYW1lKTsKICAgIGNvbnN0IGhlYWRlciA9IHNmcmFtZURhdGFWaWV3LmdldFVpbnQ4KDApOwogICAgY29uc3QgbGVuID0gKGhlYWRlciAmIDB4NzApID4+IDQ7CiAgICBjb25zdCBrbGVuID0gaGVhZGVyICYgMHgwNzsKICAgIGNvbnN0IHNmcmFtZUhlYWRlckxlbmd0aCA9IDEgKyBrbGVuICsgbGVuOwogICAgY29uc3Qgc2ZyYW1lSGVhZGVyID0gc2ZyYW1lLnNsaWNlKDAsIHNmcmFtZUhlYWRlckxlbmd0aCk7CiAgICBpZiAoc2ZyYW1lSGVhZGVyLmJ5dGVMZW5ndGggPCBzZnJhbWVIZWFkZXJMZW5ndGgpIHsKICAgICAgICB0aHJvdyBuZXcgRXJyb3IoIlVORVhQRUNURUQtU0ZSQU1FLUxFTkdUSCIpOwogICAgfQogICAgY29uc3QgY29ubmVjdGlvbklkID0gc2ZyYW1lLnNsaWNlKHNmcmFtZUhlYWRlckxlbmd0aCwgc2ZyYW1lSGVhZGVyTGVuZ3RoICsgY29ubmVjdGlvbklkTGVuZ3RoKTsKICAgIGNvbnN0IGVuY3J5cHRlZEZyYW1lID0gc2ZyYW1lLnNsaWNlKHNmcmFtZUhlYWRlckxlbmd0aCArIGNvbm5lY3Rpb25JZExlbmd0aCwgc2ZyYW1lLmJ5dGVMZW5ndGgpOwogICAgcmV0dXJuIFtzZnJhbWVIZWFkZXIsIGNvbm5lY3Rpb25JZCwgZW5jcnlwdGVkRnJhbWVdOwp9CmZ1bmN0aW9uIHBhcnNlU0ZyYW1lSGVhZGVyKHNmcmFtZUhlYWRlcikgewogICAgY29uc3Qgc2ZyYW1lSGVhZGVyRGF0YVZpZXcgPSBuZXcgRGF0YVZpZXcoc2ZyYW1lSGVhZGVyKTsKICAgIGNvbnN0IGhlYWRlciA9IHNmcmFtZUhlYWRlckRhdGFWaWV3LmdldFVpbnQ4KDApOwogICAgY29uc3QgcyA9IChoZWFkZXIgJiAweDgwKSA+PiA3OwogICAgY29uc3QgbGVuID0gKGhlYWRlciAmIDB4NzApID4+IDQ7CiAgICBjb25zdCB4ID0gKGhlYWRlciAmIDB4MDgpID4+IDM7CiAgICBjb25zdCBrbGVuID0gaGVhZGVyICYgMHgwNzsKICAgIC8vIHggZmxhZwogICAgaWYgKHggIT09IDEpIHsKICAgICAgICB0aHJvdyBuZXcgRXJyb3IoIlVORVhQRUNURUQtWC1GTEFHIik7CiAgICB9CiAgICBjb25zdCBoZWFkZXJMZW5ndGggPSAxICsga2xlbiArIGxlbjsKICAgIGlmIChzZnJhbWVIZWFkZXJEYXRhVmlldy5ieXRlTGVuZ3RoIDwgaGVhZGVyTGVuZ3RoKSB7CiAgICAgICAgdGhyb3cgbmV3IEVycm9yKCJVTkVYUEVDVEVELVNGUkFNRS1IRUFERVItTEVOR1RIIik7CiAgICB9CiAgICBjb25zdCBrZXlJZEJ1ZmZlciA9IHNmcmFtZUhlYWRlci5zbGljZSgxLCAxICsga2xlbik7CiAgICBjb25zdCBrZXlJZCA9IGFycmF5QnVmZmVyVG9OdW1iZXIoa2V5SWRCdWZmZXIpOwogICAgY29uc3QgY291bnRCdWZmZXIgPSBzZnJhbWVIZWFkZXIuc2xpY2UoMSArIGtsZW4sIGhlYWRlckxlbmd0aCk7CiAgICBjb25zdCBjb3VudCA9IGFycmF5QnVmZmVyVG9OdW1iZXIoY291bnRCdWZmZXIpOwogICAgcmV0dXJuIFtzLCBjb3VudCwga2V5SWRdOwp9Ci8qIGVzbGludC1kaXNhYmxlIEB0eXBlc2NyaXB0LWVzbGludC90cmlwbGUtc2xhc2gtcmVmZXJlbmNlLCBAdHlwZXNjcmlwdC1lc2xpbnQvbm8tdW51c2VkLXZhcnMgKi8KLy8vIDxyZWZlcmVuY2UgcGF0aD0iLi9zZnJhbWUudHMiLz4KLy8gVE9ETzog5omx44GG5pWw5YCk44GM5aSn44GN44GE566H5omA44Gn44GvIE51bWJlciDjgYvjgokgQmlnSW50IOOBq+e9ruOBjeaPm+OBiOOCiwovLyBUT0RPOiBCaWdJbnQg44Gr572u44GN5o+b44GI44KL6Zqb44Gr5aSJ5pu044GZ44KLCmNvbnN0IG1heEtleUlkID0gMiAqKiAzMjsKY29uc3QgbWF4Q291bnQgPSAyICoqIDMyOwpjb25zdCBzZWxmRGVyaXZlS2V5TWFwID0gbmV3IE1hcCgpOwpjb25zdCBjb3VudE1hcCA9IG5ldyBNYXAoKTsKY29uc3Qgd3JpdGVJVk1hcCA9IG5ldyBNYXAoKTsKY29uc3QgcmVtb3RlRGVyaXZlS2V5TWFwID0gbmV3IE1hcCgpOwpjb25zdCBsYXRlc3RSZW1vdGVLZXlJZE1hcCA9IG5ldyBNYXAoKTsKY29uc3QgbGl0dGxlRW5kaWFuID0gdHJ1ZTsKY29uc3QgYmlnRW5kaWFuID0gIWxpdHRsZUVuZGlhbjsKY29uc3QgdGV4dEVuY29kZXIgPSBuZXcgVGV4dEVuY29kZXIoKTsKY29uc3QgdGV4dERlY29kZXIgPSBuZXcgVGV4dERlY29kZXIoKTsKLy8gVlA4IOOBruOBvwovLyBUT0RPKG5ha2FpKTogVlA5IC8gQVYxIOOCguWwhuadpeeahOOBq+WvvuW/nOOCguiAg+OBiOOCiwpjb25zdCB1bmVuY3J5cHRlZEJ5dGVzID0gewogICAgLy8gSSDjg5Xjg6zjg7zjg6AKICAgIGtleTogMTAsCiAgICAvLyDpnZ4gSSDjg5Xjg6zjg7zjg6AKICAgIGRlbHRhOiAzLAogICAgLy8g44Kq44O844OH44Kj44KqCiAgICB1bmRlZmluZWQ6IDEsCn07CmZ1bmN0aW9uIGdldENvdW50KGNvbm5lY3Rpb25JZCkgewogICAgcmV0dXJuIGNvdW50TWFwLmdldChjb25uZWN0aW9uSWQpIHx8IDA7Cn0KZnVuY3Rpb24gc2V0Q291bnQoY29ubmVjdGlvbklkLCBjb3VudCkgewogICAgcmV0dXJuIGNvdW50TWFwLnNldChjb25uZWN0aW9uSWQsIGNvdW50KTsKfQpmdW5jdGlvbiBnZXRSZW1vdGVEZXJpdmVLZXkoY29ubmVjdGlvbklkLCBrZXlJZCkgewogICAgaWYgKCFyZW1vdGVEZXJpdmVLZXlNYXAuaGFzKGNvbm5lY3Rpb25JZCkpIHsKICAgICAgICB0aHJvdyBuZXcgRXJyb3IoIlJFTU9URS1ERVJJVkVLRVktTUFQLU5PVC1GT1VORCIpOwogICAgfQogICAgY29uc3QgZGVyaXZlS2V5TWFwID0gcmVtb3RlRGVyaXZlS2V5TWFwLmdldChjb25uZWN0aW9uSWQpOwogICAgaWYgKCFkZXJpdmVLZXlNYXApIHsKICAgICAgICByZXR1cm4gdW5kZWZpbmVkOwogICAgfQogICAgcmV0dXJuIGRlcml2ZUtleU1hcC5nZXQoa2V5SWQpOwp9CmZ1bmN0aW9uIHNldFJlbW90ZURlcml2ZUtleShjb25uZWN0aW9uSWQsIGtleUlkLCBkZXJpdmVLZXkpIHsKICAgIGxldCBkZXJpdmVLZXlNYXAgPSByZW1vdGVEZXJpdmVLZXlNYXAuZ2V0KGNvbm5lY3Rpb25JZCk7CiAgICBpZiAoIWRlcml2ZUtleU1hcCkgewogICAgICAgIGRlcml2ZUtleU1hcCA9IG5ldyBNYXAoKTsKICAgIH0KICAgIGRlcml2ZUtleU1hcC5zZXQoa2V5SWQsIGRlcml2ZUtleSk7CiAgICByZW1vdGVEZXJpdmVLZXlNYXAuc2V0KGNvbm5lY3Rpb25JZCwgZGVyaXZlS2V5TWFwKTsKfQpmdW5jdGlvbiBzZXRMYXRlc3RSZW1vdGVLZXlJZChjb25uZWN0aW9uSWQsIGtleUlkKSB7CiAgICBjb25zdCBsYXRlc3RSZW1vdGVLZXlJZCA9IGxhdGVzdFJlbW90ZUtleUlkTWFwLmdldChjb25uZWN0aW9uSWQpOwogICAgaWYgKGxhdGVzdFJlbW90ZUtleUlkKSB7CiAgICAgICAgaWYgKGxhdGVzdFJlbW90ZUtleUlkIDwga2V5SWQpIHsKICAgICAgICAgICAgbGF0ZXN0UmVtb3RlS2V5SWRNYXAuc2V0KGNvbm5lY3Rpb25JZCwga2V5SWQpOwogICAgICAgIH0KICAgIH0KICAgIGVsc2UgewogICAgICAgIGxhdGVzdFJlbW90ZUtleUlkTWFwLnNldChjb25uZWN0aW9uSWQsIGtleUlkKTsKICAgIH0KfQpmdW5jdGlvbiByZW1vdmVPbGRSZW1vdGVEZXJpdmVLZXlzKCkgewogICAgbGF0ZXN0UmVtb3RlS2V5SWRNYXAuZm9yRWFjaCgobGF0ZXN0S2V5SWQsIGNvbm5lY3Rpb25JZCkgPT4gewogICAgICAgIGNvbnN0IGRlcml2ZUtleU1hcCA9IHJlbW90ZURlcml2ZUtleU1hcC5nZXQoY29ubmVjdGlvbklkKTsKICAgICAgICBpZiAoZGVyaXZlS2V5TWFwKSB7CiAgICAgICAgICAgIGRlcml2ZUtleU1hcC5mb3JFYWNoKChfLCBrZXlJZCkgPT4gewogICAgICAgICAgICAgICAgaWYgKGxhdGVzdEtleUlkICE9PSBrZXlJZCkgewogICAgICAgICAgICAgICAgICAgIGRlcml2ZUtleU1hcC5kZWxldGUoa2V5SWQpOwogICAgICAgICAgICAgICAgfQogICAgICAgICAgICB9KTsKICAgICAgICB9CiAgICB9KTsKfQpmdW5jdGlvbiByZW1vdmVEZXJpdmVLZXkoY29ubmVjdGlvbklkKSB7CiAgICBsYXRlc3RSZW1vdGVLZXlJZE1hcC5kZWxldGUoY29ubmVjdGlvbklkKTsKICAgIHJlbW90ZURlcml2ZUtleU1hcC5kZWxldGUoY29ubmVjdGlvbklkKTsKfQpmdW5jdGlvbiBnZXRMYXRlc3RTZWxmRGVyaXZlS2V5KCkgewogICAgY29uc3QgZGVyaXZlS2V5ID0gc2VsZkRlcml2ZUtleU1hcC5nZXQoImxhdGVzdCIpOwogICAgaWYgKCFkZXJpdmVLZXkpIHsKICAgICAgICB0aHJvdyBuZXcgRXJyb3IoIkxBVEVTVC1TRUxGLURFUklWRUtFWS1OT1RfRk9VTkQiKTsKICAgIH0KICAgIHJldHVybiBkZXJpdmVLZXk7Cn0KZnVuY3Rpb24gc2V0U2VsZkRlcml2ZUtleShjb25uZWN0aW9uSWQsIGtleUlkLCBkZXJpdmVLZXkpIHsKICAgIGNvbnN0IGN1cnJlbnRTZWxmRGVyaXZlS2V5ID0gc2VsZkRlcml2ZUtleU1hcC5nZXQoImxhdGVzdCIpOwogICAgaWYgKGN1cnJlbnRTZWxmRGVyaXZlS2V5KSB7CiAgICAgICAgaWYgKGN1cnJlbnRTZWxmRGVyaXZlS2V5WyJrZXlJZCJdIDwga2V5SWQpIHsKICAgICAgICAgICAgY29uc3QgbmV4dFNlbGZEZXJpdmVLZXkgPSB7IGNvbm5lY3Rpb25JZCwga2V5SWQsIGRlcml2ZUtleSB9OwogICAgICAgICAgICBzZWxmRGVyaXZlS2V5TWFwLnNldCgibGF0ZXN0IiwgbmV4dFNlbGZEZXJpdmVLZXkpOwogICAgICAgIH0KICAgIH0KICAgIGVsc2UgewogICAgICAgIGNvbnN0IG5leHRTZWxmRGVyaXZlS2V5ID0geyBjb25uZWN0aW9uSWQsIGtleUlkLCBkZXJpdmVLZXkgfTsKICAgICAgICBzZWxmRGVyaXZlS2V5TWFwLnNldCgibGF0ZXN0IiwgbmV4dFNlbGZEZXJpdmVLZXkpOwogICAgfQp9CmZ1bmN0aW9uIHNpbGVuY2VGcmFtZShlbmNvZGVkRnJhbWUpIHsKICAgIC8vIGNvbm5lY3Rpb24uY3JlYXRlZCwgcmVjZWl2ZU1lc3NhZ2Ug5Y+X5L+h5YmN44Gu5aC05ZCICiAgICBpZiAoZW5jb2RlZEZyYW1lLnR5cGUgPT09IHVuZGVmaW5lZCkgewogICAgICAgIC8vIOmfs+WjsOOBr+aal+WPt+WMluOBr+OBhOOCi+OBqOiBnuOBkeOBn+OCguOBruOBmOOCg+OBquOBhOOBruOBp+e9ruOBjeaPm+OBiOOCiwogICAgICAgIGNvbnN0IG5ld0RhdGEgPSBuZXcgQXJyYXlCdWZmZXIoMyk7CiAgICAgICAgY29uc3QgbmV3VWludDggPSBuZXcgVWludDhBcnJheShuZXdEYXRhKTsKICAgICAgICAvLyBPcHVzIOOCteOCpOODrOODs+OCueODleODrOODvOODoAogICAgICAgIG5ld1VpbnQ4LnNldChbMHhkOCwgMHhmZiwgMHhmZV0pOwogICAgICAgIGVuY29kZWRGcmFtZS5kYXRhID0gbmV3RGF0YTsKICAgIH0KICAgIGVsc2UgewogICAgICAgIC8vIOaYoOWDj+OBjOato+W4uOOBmOOCg+OBquOBhOOBn+OCgSBQTEkg44K544OI44O844Og44GM55m655Sf44GX44Gm44GX44G+44GGCiAgICAgICAgLy8g44Gd44Gu44Gf44KBIDMyMHgyNDAg44Gu55yf44Gj6buS44Gq55S76Z2i44Gr572u44GN5o+b44GI44KLCiAgICAgICAgY29uc3QgbmV3RGF0YSA9IG5ldyBBcnJheUJ1ZmZlcig2MCk7CiAgICAgICAgY29uc3QgbmV3VWludDggPSBuZXcgVWludDhBcnJheShuZXdEYXRhKTsKICAgICAgICAvLyBwcmV0dGllci1pZ25vcmUKICAgICAgICBuZXdVaW50OC5zZXQoWzB4YjAsIDB4MDUsIDB4MDAsIDB4OWQsIDB4MDEsIDB4MmEsIDB4YTAsIDB4MDAsIDB4NWEsIDB4MDAsCiAgICAgICAgICAgIDB4MzksIDB4MDMsIDB4MDAsIDB4MDAsIDB4MWMsIDB4MjIsIDB4MTYsIDB4MTYsIDB4MjIsIDB4NjYsCiAgICAgICAgICAgIDB4MTIsIDB4MjAsIDB4MDQsIDB4OTAsIDB4NDAsIDB4MDAsIDB4YzUsIDB4MDEsIDB4ZTAsIDB4N2MsCiAgICAgICAgICAgIDB4NGQsIDB4MmYsIDB4ZmEsIDB4ZGQsIDB4NGQsIDB4YTUsIDB4N2YsIDB4ODksIDB4YTUsIDB4ZmYsCiAgICAgICAgICAgIDB4NWIsIDB4YTksIDB4YjQsIDB4YWYsIDB4ZjEsIDB4MzQsIDB4YmYsIDB4ZWIsIDB4NzUsIDB4MzYsCiAgICAgICAgICAgIDB4OTUsIDB4ZmUsIDB4MjYsIDB4OTYsIDB4NjAsIDB4ZmUsIDB4ZmYsIDB4YmEsIDB4ZmYsIDB4NDAsCiAgICAgICAgXSk7CiAgICAgICAgZW5jb2RlZEZyYW1lLmRhdGEgPSBuZXdEYXRhOwogICAgfQogICAgcmV0dXJuIGVuY29kZWRGcmFtZTsKfQpmdW5jdGlvbiBzZXRXcml0ZUlWKGNvbm5lY3Rpb25JZCwga2V5SWQsIHdyaXRlSVYpIHsKICAgIGNvbnN0IGtleSA9IFtjb25uZWN0aW9uSWQsIGtleUlkLnRvU3RyaW5nKCldLmpvaW4oIjoiKTsKICAgIHdyaXRlSVZNYXAuc2V0KGtleSwgd3JpdGVJVik7Cn0KZnVuY3Rpb24gZ2V0V3JpdGVJVihjb25uZWN0aW9uSWQsIGtleUlkKSB7CiAgICBjb25zdCBrZXkgPSBbY29ubmVjdGlvbklkLCBrZXlJZC50b1N0cmluZygpXS5qb2luKCI6Iik7CiAgICByZXR1cm4gd3JpdGVJVk1hcC5nZXQoa2V5KTsKfQpmdW5jdGlvbiBnZW5lcmF0ZUlWKGNvdW50LCBjb25uZWN0aW9uSWQsIGtleUlkKSB7CiAgICAvLyBUT0RPOiBrZXlJZCDjgYwgTnVtYmVyLk1BWF9TQUZFX0lOVEVHRVIsIDcgYnl0ZSDjgpLotoXjgYjjgabjgYTjgZ/loLTlkIjjga/jgqjjg6njg7zjgYvkvovlpJYKICAgIC8vIFRPRE86IGNvdW50IOOBjCBOdW1iZXIuTUFYX1NBRkVfSU5URUdFUiwgNyBieXRlIOOCkui2heOBiOOBpuOBhOOBn+WgtOWQiOOBr+OCqOODqeODvOOBi+S+i+WklgogICAgLy8gMzIgYml0IOOBvuOBpwogICAgaWYgKG1heEtleUlkIDwga2V5SWQgfHwgbWF4Q291bnQgPCBjb3VudCkgewogICAgICAgIHRocm93IG5ldyBFcnJvcigiRVhDRUVERUQtTUFYSU1VTS1CUk9BRENBU1RJTkctVElNRSIpOwogICAgfQogICAgY29uc3Qgd3JpdGVJViA9IGdldFdyaXRlSVYoY29ubmVjdGlvbklkLCBrZXlJZCk7CiAgICBpZiAoIXdyaXRlSVYpIHsKICAgICAgICB0aHJvdyBuZXcgRXJyb3IoIldSSVRFSVYtTk9ULUZPVU5EIik7CiAgICB9CiAgICBjb25zdCBwYWRkaW5nTGVuZ3RoID0gTm4gLSBVaW50MzJBcnJheS5CWVRFU19QRVJfRUxFTUVOVDsKICAgIGNvbnN0IGNvdW50V2l0aFBhZGRpbmdCdWZmZXIgPSBuZXcgQXJyYXlCdWZmZXIoTm4pOwogICAgY29uc3QgY291bnRXaXRoUGFkZGluZ0RhdGFWaWV3ID0gbmV3IERhdGFWaWV3KGNvdW50V2l0aFBhZGRpbmdCdWZmZXIpOwogICAgY291bnRXaXRoUGFkZGluZ0RhdGFWaWV3LnNldFVpbnQzMihwYWRkaW5nTGVuZ3RoLCBjb3VudCwgYmlnRW5kaWFuKTsKICAgIGNvbnN0IGl2ID0gbmV3IFVpbnQ4QXJyYXkoTm4pOwogICAgY29uc3QgY291bnRXaXRoUGFkZGluZyA9IG5ldyBVaW50OEFycmF5KGNvdW50V2l0aFBhZGRpbmdCdWZmZXIpOwogICAgZm9yIChsZXQgaSA9IDA7IGkgPCBObjsgaSsrKSB7CiAgICAgICAgaXZbaV0gPSB3cml0ZUlWW2ldIF4gY291bnRXaXRoUGFkZGluZ1tpXTsKICAgIH0KICAgIHJldHVybiBpdjsKfQpmdW5jdGlvbiBwYXJzZVBheWxvYWQocGF5bG9hZFR5cGUsIHBheWxvYWQpIHsKICAgIHJldHVybiBbCiAgICAgICAgbmV3IFVpbnQ4QXJyYXkocGF5bG9hZCwgMCwgdW5lbmNyeXB0ZWRCeXRlc1twYXlsb2FkVHlwZV0pLAogICAgICAgIG5ldyBVaW50OEFycmF5KHBheWxvYWQsIHVuZW5jcnlwdGVkQnl0ZXNbcGF5bG9hZFR5cGVdKSwKICAgIF07Cn0KZnVuY3Rpb24gZW5jb2RlRnJhbWVBZGQoaGVhZGVyLCBzZnJhbWVIZWFkZXIsIGNvbm5lY3Rpb25JZCkgewogICAgY29uc3QgY29ubmVjdGlvbklkRGF0YSA9IHRleHRFbmNvZGVyLmVuY29kZShjb25uZWN0aW9uSWQpOwogICAgY29uc3QgZnJhbWVBZGQgPSBuZXcgVWludDhBcnJheShoZWFkZXIuYnl0ZUxlbmd0aCArIHNmcmFtZUhlYWRlci5ieXRlTGVuZ3RoICsgY29ubmVjdGlvbklkRGF0YS5ieXRlTGVuZ3RoKTsKICAgIGZyYW1lQWRkLnNldChoZWFkZXIsIDApOwogICAgZnJhbWVBZGQuc2V0KHNmcmFtZUhlYWRlciwgaGVhZGVyLmJ5dGVMZW5ndGgpOwogICAgZnJhbWVBZGQuc2V0KGNvbm5lY3Rpb25JZERhdGEsIGhlYWRlci5ieXRlTGVuZ3RoICsgc2ZyYW1lSGVhZGVyLmJ5dGVMZW5ndGgpOwogICAgcmV0dXJuIGZyYW1lQWRkOwp9CmFzeW5jIGZ1bmN0aW9uIGVuY3J5cHRGdW5jdGlvbihlbmNvZGVkRnJhbWUsIGNvbnRyb2xsZXIpIHsKICAgIGNvbnN0IHsgY29ubmVjdGlvbklkLCBrZXlJZCwgZGVyaXZlS2V5IH0gPSBnZXRMYXRlc3RTZWxmRGVyaXZlS2V5KCk7CiAgICBpZiAoIWRlcml2ZUtleSkgewogICAgICAgIGNvbnNvbGUuaW5mbygiREVSSVZFS0VZLU5PVC1GT1VORCIpOwogICAgICAgIHJldHVybjsKICAgIH0KICAgIGNvbnN0IGN1cnJlbnRDb3VudCA9IGdldENvdW50KGNvbm5lY3Rpb25JZCk7CiAgICAvLyBjb3VudCDjgYwgMzIgYml0IOS7peS4iuOBruWgtOWQiOOBr+WBnOatouOBmeOCiwogICAgaWYgKGN1cnJlbnRDb3VudCA+IG1heENvdW50KSB7CiAgICAgICAgcG9zdE1lc3NhZ2UoeyB0eXBlOiAiZGlzY29ubmVjdCIgfSk7CiAgICB9CiAgICBjb25zdCBpdiA9IGdlbmVyYXRlSVYoY3VycmVudENvdW50LCBjb25uZWN0aW9uSWQsIGtleUlkKTsKICAgIGlmICghaXYpIHsKICAgICAgICBjb25zb2xlLmluZm8oIldSSVRFSVYtTk9ULUZPVU5EIik7CiAgICAgICAgcmV0dXJuOwogICAgfQogICAgY29uc3QgW2hlYWRlciwgcGF5bG9hZF0gPSBwYXJzZVBheWxvYWQoZW5jb2RlZEZyYW1lLnR5cGUsIGVuY29kZWRGcmFtZS5kYXRhKTsKICAgIGNvbnN0IHNmcmFtZUhlYWRlciA9IGVuY29kZVNGcmFtZUhlYWRlcigwLCBjdXJyZW50Q291bnQsIGtleUlkKTsKICAgIGNvbnN0IGZyYW1lQWRkID0gZW5jb2RlRnJhbWVBZGQoaGVhZGVyLCBzZnJhbWVIZWFkZXIsIGNvbm5lY3Rpb25JZCk7CiAgICBjcnlwdG8uc3VidGxlCiAgICAgICAgLmVuY3J5cHQoewogICAgICAgIG5hbWU6ICJBRVMtR0NNIiwKICAgICAgICBpdjogaXYsCiAgICAgICAgLy8g5pqX5Y+35YyW44GV44KM44Gm44GE44Gq44GE6YOo5YiGCiAgICAgICAgYWRkaXRpb25hbERhdGE6IGZyYW1lQWRkLAogICAgfSwgZGVyaXZlS2V5LCBwYXlsb2FkKQogICAgICAgIC50aGVuKChjaXBoZXJUZXh0KSA9PiB7CiAgICAgICAgY29uc3QgbmV3RGF0YSA9IG5ldyBBcnJheUJ1ZmZlcihmcmFtZUFkZC5ieXRlTGVuZ3RoICsgY2lwaGVyVGV4dC5ieXRlTGVuZ3RoKTsKICAgICAgICBjb25zdCBuZXdEYXRhVWludDggPSBuZXcgVWludDhBcnJheShuZXdEYXRhKTsKICAgICAgICBuZXdEYXRhVWludDguc2V0KGZyYW1lQWRkLCAwKTsKICAgICAgICBuZXdEYXRhVWludDguc2V0KG5ldyBVaW50OEFycmF5KGNpcGhlclRleHQpLCBmcmFtZUFkZC5ieXRlTGVuZ3RoKTsKICAgICAgICBlbmNvZGVkRnJhbWUuZGF0YSA9IG5ld0RhdGE7CiAgICAgICAgY29udHJvbGxlci5lbnF1ZXVlKGVuY29kZWRGcmFtZSk7CiAgICB9KTsKICAgIHNldENvdW50KGNvbm5lY3Rpb25JZCwgY3VycmVudENvdW50ICsgMSk7Cn0KYXN5bmMgZnVuY3Rpb24gZGVjcnlwdEZ1bmN0aW9uKGVuY29kZWRGcmFtZSwgY29udHJvbGxlcikgewogICAgLy8g56m644OV44Os44O844Og5a++5b+cCiAgICBpZiAoZW5jb2RlZEZyYW1lLmRhdGEuYnl0ZUxlbmd0aCA8IDEpIHsKICAgICAgICBjb25zb2xlLmluZm8oIkVNUFRZLURBVEEiKTsKICAgICAgICByZXR1cm47CiAgICB9CiAgICB0cnkgewogICAgICAgIGNvbnN0IGZyYW1lTWV0YWRhdGFCdWZmZXIgPSBlbmNvZGVkRnJhbWUuZGF0YS5zbGljZSgwLCB1bmVuY3J5cHRlZEJ5dGVzW2VuY29kZWRGcmFtZS50eXBlXSk7CiAgICAgICAgY29uc3QgZnJhbWVNZXRhZGF0YSA9IG5ldyBVaW50OEFycmF5KGZyYW1lTWV0YWRhdGFCdWZmZXIpOwogICAgICAgIGNvbnN0IFtzZnJhbWVIZWFkZXJCdWZmZXIsIGNvbm5lY3Rpb25JZEJ1ZmZlciwgZW5jcnlwdGVkRnJhbWVCdWZmZXJdID0gc3BsaXRIZWFkZXIoZW5jb2RlZEZyYW1lLmRhdGEuc2xpY2UodW5lbmNyeXB0ZWRCeXRlc1tlbmNvZGVkRnJhbWUudHlwZV0pKTsKICAgICAgICBjb25zdCBzZnJhbWVIZWFkZXIgPSBuZXcgVWludDhBcnJheShzZnJhbWVIZWFkZXJCdWZmZXIpOwogICAgICAgIGNvbnN0IGNvbm5lY3Rpb25JZCA9IHRleHREZWNvZGVyLmRlY29kZShjb25uZWN0aW9uSWRCdWZmZXIpOwogICAgICAgIGNvbnN0IFtzLCBjb3VudCwga2V5SWRdID0gcGFyc2VTRnJhbWVIZWFkZXIoc2ZyYW1lSGVhZGVyQnVmZmVyKTsKICAgICAgICAvLyDku4rlm57jga8gcyBmbGFnIOOBryAwIOOBruOBvwogICAgICAgIGlmIChzICE9PSAwKSB7CiAgICAgICAgICAgIHRocm93IG5ldyBFcnJvcigiVU5FWFBFQ1RFRC1TLUZMQUciKTsKICAgICAgICB9CiAgICAgICAgY29uc3QgZGVyaXZlS2V5ID0gZ2V0UmVtb3RlRGVyaXZlS2V5KGNvbm5lY3Rpb25JZCwga2V5SWQpOwogICAgICAgIGlmICghZGVyaXZlS2V5KSB7CiAgICAgICAgICAgIGNvbnNvbGUud2FybigiREVSSVZFS0VZLU5PVC1GT1VORDogIiwgY29ubmVjdGlvbklkLCBrZXlJZCk7CiAgICAgICAgICAgIHJldHVybjsKICAgICAgICB9CiAgICAgICAgY29uc3QgaXYgPSBnZW5lcmF0ZUlWKGNvdW50LCBjb25uZWN0aW9uSWQsIGtleUlkKTsKICAgICAgICBpZiAoIWl2KSB7CiAgICAgICAgICAgIGNvbnNvbGUuaW5mbygiV1JJVEVJVi1OT1QtRk9VTkQiKTsKICAgICAgICAgICAgcmV0dXJuOwogICAgICAgIH0KICAgICAgICBjb25zdCBmcmFtZUFkZCA9IGVuY29kZUZyYW1lQWRkKGZyYW1lTWV0YWRhdGEsIHNmcmFtZUhlYWRlciwgY29ubmVjdGlvbklkKTsKICAgICAgICBjcnlwdG8uc3VidGxlCiAgICAgICAgICAgIC5kZWNyeXB0KHsKICAgICAgICAgICAgbmFtZTogIkFFUy1HQ00iLAogICAgICAgICAgICBpdjogaXYsCiAgICAgICAgICAgIGFkZGl0aW9uYWxEYXRhOiBmcmFtZUFkZCwKICAgICAgICB9LCBkZXJpdmVLZXksIG5ldyBVaW50OEFycmF5KGVuY3J5cHRlZEZyYW1lQnVmZmVyKSkKICAgICAgICAgICAgLnRoZW4oKHBsYWluVGV4dCkgPT4gewogICAgICAgICAgICBjb25zdCBuZXdEYXRhID0gbmV3IEFycmF5QnVmZmVyKGZyYW1lTWV0YWRhdGFCdWZmZXIuYnl0ZUxlbmd0aCArIHBsYWluVGV4dC5ieXRlTGVuZ3RoKTsKICAgICAgICAgICAgY29uc3QgbmV3VWludDggPSBuZXcgVWludDhBcnJheShuZXdEYXRhKTsKICAgICAgICAgICAgbmV3VWludDguc2V0KG5ldyBVaW50OEFycmF5KGZyYW1lTWV0YWRhdGFCdWZmZXIsIDAsIHVuZW5jcnlwdGVkQnl0ZXNbZW5jb2RlZEZyYW1lLnR5cGVdKSk7CiAgICAgICAgICAgIG5ld1VpbnQ4LnNldChuZXcgVWludDhBcnJheShwbGFpblRleHQpLCB1bmVuY3J5cHRlZEJ5dGVzW2VuY29kZWRGcmFtZS50eXBlXSk7CiAgICAgICAgICAgIGVuY29kZWRGcmFtZS5kYXRhID0gbmV3RGF0YTsKICAgICAgICAgICAgY29udHJvbGxlci5lbnF1ZXVlKGVuY29kZWRGcmFtZSk7CiAgICAgICAgfSk7CiAgICB9CiAgICBjYXRjaCAoZSkgewogICAgICAgIC8vIOaDs+WumuWkluOBruODkeOCseODg+ODiOODleOCqeODvOODnuODg+ODiOOCkuWPl+S/oeOBl+OBn+WgtOWQiAogICAgICAgIGNvbnRyb2xsZXIuZW5xdWV1ZShzaWxlbmNlRnJhbWUoZW5jb2RlZEZyYW1lKSk7CiAgICB9Cn0KLyogZXNsaW50LWRpc2FibGUgQHR5cGVzY3JpcHQtZXNsaW50L3RyaXBsZS1zbGFzaC1yZWZlcmVuY2UgKi8KLy8vIDxyZWZlcmVuY2UgcGF0aD0iLi9lMmVlLnRzIi8+Ci8vIG5vbmNlIOOCteOCpOOCugpjb25zdCBObiA9IDEyOwovLyBrZXkg44K144Kk44K6CmNvbnN0IE5rID0gMTY7Ci8vIGtleSDjgrXjgqTjgrrvvIhiaXTvvIkKY29uc3Qga2V5TGVuZ3RoID0gTmsgKiA4Owphc3luYyBmdW5jdGlvbiBnZW5lcmF0ZURlcml2ZUtleShtYXRlcmlhbCkgewogICAgY29uc3Qgc2FsdCA9IHRleHRFbmNvZGVyLmVuY29kZSgiU0ZyYW1lMTAiKTsKICAgIGNvbnN0IGluZm8gPSB0ZXh0RW5jb2Rlci5lbmNvZGUoImtleSIpOwogICAgY29uc3QgZGVyaXZlS2V5ID0gYXdhaXQgY3J5cHRvLnN1YnRsZS5kZXJpdmVLZXkoewogICAgICAgIG5hbWU6ICJIS0RGIiwKICAgICAgICBzYWx0OiBzYWx0LAogICAgICAgIGhhc2g6ICJTSEEtMjU2IiwKICAgICAgICBpbmZvOiBpbmZvLAogICAgfSwgbWF0ZXJpYWwsIHsKICAgICAgICBuYW1lOiAiQUVTLUdDTSIsCiAgICAgICAgbGVuZ3RoOiBrZXlMZW5ndGgsCiAgICB9LCBmYWxzZSwgWyJlbmNyeXB0IiwgImRlY3J5cHQiXSk7CiAgICByZXR1cm4gZGVyaXZlS2V5Owp9CmFzeW5jIGZ1bmN0aW9uIGdlbmVyYXRlV3JpdGVJVihtYXRlcmlhbCkgewogICAgY29uc3Qgc2FsdCA9IHRleHRFbmNvZGVyLmVuY29kZSgiU0ZyYW1lMTAiKTsKICAgIGNvbnN0IGluZm8gPSB0ZXh0RW5jb2Rlci5lbmNvZGUoInNhbHQiKTsKICAgIGNvbnN0IHdyaXRlSVZCdWZmZXIgPSBhd2FpdCBjcnlwdG8uc3VidGxlLmRlcml2ZUJpdHMoewogICAgICAgIG5hbWU6ICJIS0RGIiwKICAgICAgICBzYWx0OiBzYWx0LAogICAgICAgIGhhc2g6ICJTSEEtMzg0IiwKICAgICAgICBpbmZvOiBpbmZvLAogICAgfSwgbWF0ZXJpYWwsIAogICAgLy8gSVYg44GvIDk2IOODk+ODg+ODiOOBquOBruOBpwogICAgTm4gKiA4KTsKICAgIGNvbnN0IHdyaXRlSVYgPSBuZXcgVWludDhBcnJheSh3cml0ZUlWQnVmZmVyKTsKICAgIHJldHVybiB3cml0ZUlWOwp9CmxldCByZW1vdmFsVGltZW91dElkID0gMDsKb25tZXNzYWdlID0gKGV2ZW50KSA9PiB7CiAgICBjb25zdCB7IHR5cGUgfSA9IGV2ZW50LmRhdGE7CiAgICBpZiAodHlwZSA9PT0gInNlbGZTZWNyZXRLZXlNYXRlcmlhbCIpIHsKICAgICAgICBjb25zdCB7IHNlbGZTZWNyZXRLZXlNYXRlcmlhbCwgc2VsZkNvbm5lY3Rpb25JZCwgc2VsZktleUlkLCB3YWl0aW5nVGltZSB9ID0gZXZlbnQuZGF0YTsKICAgICAgICBjb25zdCB0aW1lb3V0SWQgPSBzZXRUaW1lb3V0KCgpID0+IHsKICAgICAgICAgICAgY3J5cHRvLnN1YnRsZQogICAgICAgICAgICAgICAgLmltcG9ydEtleSgicmF3Iiwgc2VsZlNlY3JldEtleU1hdGVyaWFsLmJ1ZmZlciwgIkhLREYiLCBmYWxzZSwgWyJkZXJpdmVCaXRzIiwgImRlcml2ZUtleSJdKQogICAgICAgICAgICAgICAgLnRoZW4oKG1hdGVyaWFsKSA9PiB7CiAgICAgICAgICAgICAgICBnZW5lcmF0ZURlcml2ZUtleShtYXRlcmlhbCkudGhlbigoZGVyaXZlS2V5KSA9PiB7CiAgICAgICAgICAgICAgICAgICAgc2V0U2VsZkRlcml2ZUtleShzZWxmQ29ubmVjdGlvbklkLCBzZWxmS2V5SWQsIGRlcml2ZUtleSk7CiAgICAgICAgICAgICAgICB9KTsKICAgICAgICAgICAgICAgIGdlbmVyYXRlV3JpdGVJVihtYXRlcmlhbCkudGhlbigod3JpdGVJVikgPT4gewogICAgICAgICAgICAgICAgICAgIHNldFdyaXRlSVYoc2VsZkNvbm5lY3Rpb25JZCwgc2VsZktleUlkLCB3cml0ZUlWKTsKICAgICAgICAgICAgICAgIH0pOwogICAgICAgICAgICAgICAgY2xlYXJUaW1lb3V0KHRpbWVvdXRJZCk7CiAgICAgICAgICAgIH0pOwogICAgICAgIH0sIHdhaXRpbmdUaW1lIHx8IDApOwogICAgICAgIC8vIFRPRE86ICsxMDAwIOOBp+mNteeUn+aIkOW+jOOBq+Wun+ihjOOBleOCjOOCi+OCiOOBhuOBq+OBl+OBpuOBhOOCi+OBjOefreOBhOWgtOWQiOOBr+S8uOOBsOOBmQogICAgICAgIGNvbnN0IHJlbW92YWxXYWl0aW5nVGltZSA9ICh3YWl0aW5nVGltZSB8fCAwKSArIDEwMDA7CiAgICAgICAgaWYgKHJlbW92YWxUaW1lb3V0SWQpIHsKICAgICAgICAgICAgLy8g5YuV5L2c5riI44G/44K/44Kk44Oe44O85pyJ44KKCiAgICAgICAgICAgIGlmICh3YWl0aW5nVGltZSkgewogICAgICAgICAgICAgICAgLy8gY29ubmVjdGlvbi5kZXN0cm95ZWQKICAgICAgICAgICAgICAgIGNsZWFyVGltZW91dChyZW1vdmFsVGltZW91dElkKTsKICAgICAgICAgICAgICAgIHJlbW92YWxUaW1lb3V0SWQgPSBzZXRUaW1lb3V0KCgpID0+IHsKICAgICAgICAgICAgICAgICAgICByZW1vdmVPbGRSZW1vdGVEZXJpdmVLZXlzKCk7CiAgICAgICAgICAgICAgICAgICAgY2xlYXJUaW1lb3V0KHJlbW92YWxUaW1lb3V0SWQpOwogICAgICAgICAgICAgICAgICAgIHJlbW92YWxUaW1lb3V0SWQgPSAwOwogICAgICAgICAgICAgICAgfSwgcmVtb3ZhbFdhaXRpbmdUaW1lKTsKICAgICAgICAgICAgfQogICAgICAgIH0KICAgICAgICBlbHNlIHsKICAgICAgICAgICAgLy8g5YuV5L2c5riI44G/44K/44Kk44Oe44O844Gq44GXCiAgICAgICAgICAgIC8vIGNvbm5lY3Rpb24uY3JlYXRlZCDjga7loLTlkIjjgoLlsJHjgZflrp/ooYzjgpLpgYXjgonjgZvjgosKICAgICAgICAgICAgcmVtb3ZhbFRpbWVvdXRJZCA9IHNldFRpbWVvdXQoKCkgPT4gewogICAgICAgICAgICAgICAgcmVtb3ZlT2xkUmVtb3RlRGVyaXZlS2V5cygpOwogICAgICAgICAgICAgICAgY2xlYXJUaW1lb3V0KHJlbW92YWxUaW1lb3V0SWQpOwogICAgICAgICAgICAgICAgcmVtb3ZhbFRpbWVvdXRJZCA9IDA7CiAgICAgICAgICAgIH0sIHJlbW92YWxXYWl0aW5nVGltZSk7CiAgICAgICAgfQogICAgfQogICAgZWxzZSBpZiAodHlwZSA9PT0gInJlbW90ZVNlY3JldEtleU1hdGVyaWFscyIpIHsKICAgICAgICBjb25zdCB7IHJlbW90ZVNlY3JldEtleU1hdGVyaWFscyB9ID0gZXZlbnQuZGF0YTsKICAgICAgICBmb3IgKGNvbnN0IFtjb25uZWN0aW9uSWQsIHJlbW90ZVNlY3JldEtleU1hdGVyaWFsXSBvZiBPYmplY3QuZW50cmllcyhyZW1vdGVTZWNyZXRLZXlNYXRlcmlhbHMpKSB7CiAgICAgICAgICAgIGNvbnN0IHsga2V5SWQsIHNlY3JldEtleU1hdGVyaWFsIH0gPSByZW1vdGVTZWNyZXRLZXlNYXRlcmlhbDsKICAgICAgICAgICAgY3J5cHRvLnN1YnRsZQogICAgICAgICAgICAgICAgLmltcG9ydEtleSgicmF3Iiwgc2VjcmV0S2V5TWF0ZXJpYWwuYnVmZmVyLCAiSEtERiIsIGZhbHNlLCBbImRlcml2ZUJpdHMiLCAiZGVyaXZlS2V5Il0pCiAgICAgICAgICAgICAgICAudGhlbigobWF0ZXJpYWwpID0+IHsKICAgICAgICAgICAgICAgIGdlbmVyYXRlRGVyaXZlS2V5KG1hdGVyaWFsKS50aGVuKChkZXJpdmVLZXkpID0+IHsKICAgICAgICAgICAgICAgICAgICBzZXRSZW1vdGVEZXJpdmVLZXkoY29ubmVjdGlvbklkLCBrZXlJZCwgZGVyaXZlS2V5KTsKICAgICAgICAgICAgICAgIH0pOwogICAgICAgICAgICAgICAgZ2VuZXJhdGVXcml0ZUlWKG1hdGVyaWFsKS50aGVuKCh3cml0ZUlWKSA9PiB7CiAgICAgICAgICAgICAgICAgICAgc2V0V3JpdGVJVihjb25uZWN0aW9uSWQsIGtleUlkLCB3cml0ZUlWKTsKICAgICAgICAgICAgICAgIH0pOwogICAgICAgICAgICAgICAgc2V0TGF0ZXN0UmVtb3RlS2V5SWQoY29ubmVjdGlvbklkLCBrZXlJZCk7CiAgICAgICAgICAgIH0pOwogICAgICAgIH0KICAgIH0KICAgIGVsc2UgaWYgKHR5cGUgPT09ICJyZW1vdmVSZW1vdGVEZXJpdmVLZXkiKSB7CiAgICAgICAgY29uc3QgeyBjb25uZWN0aW9uSWQgfSA9IGV2ZW50LmRhdGE7CiAgICAgICAgcmVtb3ZlRGVyaXZlS2V5KGNvbm5lY3Rpb25JZCk7CiAgICB9CiAgICBlbHNlIGlmICh0eXBlID09PSAiZW5jcnlwdCIpIHsKICAgICAgICBjb25zdCB7IHJlYWRhYmxlU3RyZWFtLCB3cml0YWJsZVN0cmVhbSB9ID0gZXZlbnQuZGF0YTsKICAgICAgICBjb25zdCB0cmFuc2Zvcm1TdHJlYW0gPSBuZXcgVHJhbnNmb3JtU3RyZWFtKHsKICAgICAgICAgICAgdHJhbnNmb3JtOiBlbmNyeXB0RnVuY3Rpb24sCiAgICAgICAgfSk7CiAgICAgICAgcmVhZGFibGVTdHJlYW0ucGlwZVRocm91Z2godHJhbnNmb3JtU3RyZWFtKS5waXBlVG8od3JpdGFibGVTdHJlYW0pOwogICAgfQogICAgZWxzZSBpZiAodHlwZSA9PT0gImRlY3J5cHQiKSB7CiAgICAgICAgY29uc3QgeyByZWFkYWJsZVN0cmVhbSwgd3JpdGFibGVTdHJlYW0gfSA9IGV2ZW50LmRhdGE7CiAgICAgICAgY29uc3QgdHJhbnNmb3JtU3RyZWFtID0gbmV3IFRyYW5zZm9ybVN0cmVhbSh7CiAgICAgICAgICAgIHRyYW5zZm9ybTogZGVjcnlwdEZ1bmN0aW9uLAogICAgICAgIH0pOwogICAgICAgIHJlYWRhYmxlU3RyZWFtLnBpcGVUaHJvdWdoKHRyYW5zZm9ybVN0cmVhbSkucGlwZVRvKHdyaXRhYmxlU3RyZWFtKTsKICAgIH0KICAgIGVsc2UgaWYgKHR5cGUgPT09ICJjbGVhciIpIHsKICAgICAgICBjb3VudE1hcC5jbGVhcigpOwogICAgICAgIHdyaXRlSVZNYXAuY2xlYXIoKTsKICAgICAgICByZW1vdGVEZXJpdmVLZXlNYXAuY2xlYXIoKTsKICAgICAgICBzZWxmRGVyaXZlS2V5TWFwLmNsZWFyKCk7CiAgICB9Cn07Cg==");
          this.worker = new Worker(URL.createObjectURL(new Blob([workerScript], { type: "application/javascript" })));
          this.worker.onmessage = (event) => {
              const { operation } = event.data;
              if (operation === "disconnect" && typeof this.onWorkerDisconnect === "function") {
                  this.onWorkerDisconnect();
              }
          };
      }
      // worker の掃除をする
      clearWorker() {
          if (this.worker) {
              this.worker.postMessage({
                  type: "clear",
              });
          }
      }
      // worker を終了する
      terminateWorker() {
          if (this.worker) {
              this.worker.terminate();
          }
      }
      // 初期化処理
      async init() {
          if (!window.Go) {
              throw new Error(`Failed to load module Go. window.Go is ${window.Go}.`);
          }
          const go = new Go();
          const { instance } = await WebAssembly.instantiateStreaming(fetch("wasm.wasm"), go.importObject);
          go.run(instance);
          if (!window.e2ee) {
              throw new Error(`Failed to load module e2ee. window.e2ee is ${window.e2ee}.`);
          }
          const { preKeyBundle } = await window.e2ee.init();
          return preKeyBundle;
      }
      setupSenderTransform(sender) {
          if (!sender.track)
              return;
          // @ts-ignore トライアル段階の API なので無視する
          const senderStreams = sender.createEncodedStreams();
          const readableStream = senderStreams.readableStream || senderStreams.readable;
          const writableStream = senderStreams.writableStream || senderStreams.writable;
          if (!this.worker) {
              throw new Error("Worker is null. Call startWorker in advance.");
          }
          const message = {
              type: "encrypt",
              readableStream: readableStream,
              writableStream: writableStream,
          };
          this.worker.postMessage(message, [readableStream, writableStream]);
      }
      setupReceiverTransform(receiver) {
          // @ts-ignore トライアル段階の API なので無視する
          const receiverStreams = receiver.createEncodedStreams();
          const readableStream = receiverStreams.readableStream || receiverStreams.readable;
          const writableStream = receiverStreams.writableStream || receiverStreams.writable;
          if (!this.worker) {
              throw new Error("Worker is null. Call startWorker in advance.");
          }
          const message = {
              type: "decrypt",
              readableStream: readableStream,
              writableStream: writableStream,
          };
          this.worker.postMessage(message, [readableStream, writableStream]);
      }
      postRemoteSecretKeyMaterials(result) {
          if (!this.worker) {
              throw new Error("Worker is null. Call startWorker in advance.");
          }
          this.worker.postMessage({
              type: "remoteSecretKeyMaterials",
              remoteSecretKeyMaterials: result.remoteSecretKeyMaterials,
          });
      }
      postSelfSecretKeyMaterial(selfConnectionId, selfKeyId, selfSecretKeyMaterial, waitingTime) {
          if (!this.worker) {
              throw new Error("Worker is null. Call startWorker in advance.");
          }
          this.worker.postMessage({
              type: "selfSecretKeyMaterial",
              selfConnectionId: selfConnectionId,
              selfKeyId: selfKeyId,
              selfSecretKeyMaterial: selfSecretKeyMaterial,
              waitingTime: waitingTime,
          });
      }
      startSession(connectionId, preKeyBundle) {
          const [result, err] = window.e2ee.startSession(connectionId, preKeyBundle.identityKey, preKeyBundle.signedPreKey, preKeyBundle.preKeySignature);
          if (err) {
              throw err;
          }
          return result;
      }
      stopSession(connectionId) {
          const [result, err] = window.e2ee.stopSession(connectionId);
          if (err) {
              throw err;
          }
          return result;
      }
      receiveMessage(message) {
          const [result, err] = window.e2ee.receiveMessage(message);
          if (err) {
              throw err;
          }
          return result;
      }
      start(selfConnectionId) {
          const [result, err] = window.e2ee.start(selfConnectionId);
          if (err) {
              throw err;
          }
          return result;
      }
      addPreKeyBundle(connectionId, preKeyBundle) {
          const err = window.e2ee.addPreKeyBundle(connectionId, preKeyBundle.identityKey, preKeyBundle.signedPreKey, preKeyBundle.preKeySignature);
          if (err) {
              throw err;
          }
      }
      selfFingerprint() {
          return window.e2ee.selfFingerprint();
      }
      remoteFingerprints() {
          return window.e2ee.remoteFingerprints();
      }
      static version() {
          // @ts-ignore
          return '2020.5.0-canary.0-dev';
      }
      static wasmVersion() {
          return window.e2ee.version();
      }
  }

  return SoraE2EE;

})));
