/**
 * @sora/sdk
 * undefined
 * @version: 2020.5.0-canary.0-dev
 * @author: Shiguredo Inc.
 * @license: Apache-2.0
 **/(function(a,b){"object"==typeof exports&&"undefined"!=typeof module?module.exports=b():"function"==typeof define&&define.amd?define(b):(a="undefined"==typeof globalThis?a||self:globalThis,a.Sora=b())})(this,function(){'use strict';function a(){const a=window.navigator.userAgent.toLocaleLowerCase();if(-1!==a.indexOf("edge"))return"edge";return-1!==a.indexOf("chrome")&&-1===a.indexOf("edge")?"chrome":-1!==a.indexOf("safari")&&-1===a.indexOf("chrome")?"safari":-1===a.indexOf("opera")?-1===a.indexOf("firefox")?null:"firefox":"opera"}function b(b,c){if("boolean"!=typeof c&&"VP9"===c.codec_type)return!1;if(("upstream"===b||"sendrecv"===b||"sendonly"===b)&&"firefox"===a())return!1;if("safari"===a()){const a=window.navigator.appVersion.toLowerCase(),d=/version\/([\d.]+)/.exec(a);if(!d)return!1;const e=d.pop();if(!e)return!1;const f=parseFloat(e);if(("upstream"===b||"sendrecv"===b||"sendonly"===b)&&14<=f)return!0;if(("downstream"===b||"recvonly"===b)&&12.1<=f){if(12.1<=f)return!0;if(12==f&&"boolean"!=typeof c&&"H264"===c.codec_type)return!0}return!1}return!0}function c(){return"edge"===a()}function d(){return"safari"===a()}function e(a,c,d,e,f){if("upstream"!==c&&"downstream"!==c&&"sendrecv"!==c&&"sendonly"!==c&&"recvonly"!==c)throw new Error("Unknown role type");if(null===d||void 0===d)throw new Error("channelId can not be null or undefined");const g={type:"connect",sora_client:`Sora JavaScript SDK ${"2020.5.0-canary.0-dev"}`,environment:window.navigator.userAgent,role:c,channel_id:d,sdp:a,audio:!0,video:!0};if(void 0!==e&&(g.metadata=e),"signalingNotifyMetadata"in f&&(g.signaling_notify_metadata=f.signalingNotifyMetadata),"multistream"in f&&!0===f.multistream&&(g.multistream=!0,"spotlight"in f&&(g.spotlight=f.spotlight,"spotlightNumber"in f&&(g.spotlight_number=f.spotlightNumber))),"simulcast"in f||"simulcastRid"in f){"simulcast"in f&&!0===f.simulcast&&(g.simulcast=!0);void 0!==f.simulcastRid&&0<=["r0","r1","r2"].indexOf(f.simulcastRid)&&(g.simulcast_rid=f.simulcastRid)}"clientId"in f&&f.clientId&&(g.client_id=f.clientId);const h=["audioCodecType","audioBitRate"],i=["audioOpusParamsChannels","audioOpusParamsClockRate","audioOpusParamsMaxplaybackrate","audioOpusParamsStereo","audioOpusParamsSpropStereo","audioOpusParamsMinptime","audioOpusParamsPtime","audioOpusParamsUseinbandfec","audioOpusParamsUsedtx"],j=["videoCodecType","videoBitRate"],k=Object.assign({},f);Object.keys(k).forEach(a=>{"audio"===a&&"boolean"==typeof k[a]||"video"===a&&"boolean"==typeof k[a]||0<=h.indexOf(a)&&null!==k[a]||0<=i.indexOf(a)&&null!==k[a]||0<=j.indexOf(a)&&null!==k[a]||delete k[a]}),void 0!==k.audio&&(g.audio=k.audio);const l=Object.keys(k).some(a=>0<=h.indexOf(a));g.audio&&l&&(g.audio={},"audioCodecType"in k&&(g.audio.codec_type=k.audioCodecType),"audioBitRate"in k&&(g.audio.bit_rate=k.audioBitRate));const m=Object.keys(k).some(a=>0<=i.indexOf(a));g.audio&&m&&("object"!=typeof g.audio&&(g.audio={}),g.audio.opus_params={},"audioOpusParamsChannels"in k&&(g.audio.opus_params.channels=k.audioOpusParamsChannels),"audioOpusParamsClockRate"in k&&(g.audio.opus_params.clock_rate=k.audioOpusParamsClockRate),"audioOpusParamsMaxplaybackrate"in k&&(g.audio.opus_params.maxplaybackrate=k.audioOpusParamsMaxplaybackrate),"audioOpusParamsStereo"in k&&(g.audio.opus_params.stereo=k.audioOpusParamsStereo),"audioOpusParamsSpropStereo"in k&&(g.audio.opus_params.sprop_stereo=k.audioOpusParamsSpropStereo),"audioOpusParamsMinptime"in k&&(g.audio.opus_params.minptime=k.audioOpusParamsMinptime),"audioOpusParamsPtime"in k&&(g.audio.opus_params.ptime=k.audioOpusParamsPtime),"audioOpusParamsUseinbandfec"in k&&(g.audio.opus_params.useinbandfec=k.audioOpusParamsUseinbandfec),"audioOpusParamsUsedtx"in k&&(g.audio.opus_params.usedtx=k.audioOpusParamsUsedtx)),void 0!==k.video&&(g.video=k.video);const n=Object.keys(k).some(a=>0<=j.indexOf(a));if(g.video&&n&&(g.video={},"videoCodecType"in k&&(g.video.codec_type=k.videoCodecType),"videoBitRate"in k&&(g.video.bit_rate=k.videoBitRate)),g.simulcast&&!b(g.role,g.video))throw new Error("Simulcast can not be used with this browser");return"e2ee"in f&&(!0===g.video&&(g.video={}),g.video&&(g.video.codec_type="VP8"),g.e2ee=!0),g}function f(a,b,d){let e="";window.performance&&(e="["+(window.performance.now()/1e3).toFixed(3)+"]"),a&&(e=e+"["+a+"]"),c()?console.log(e+" "+b+"\n",d):console.info(e+" "+b+"\n",d)}function g(){throw new Error("Dynamic requires are not currently supported by @rollup/plugin-commonjs")}var h="undefined"==typeof globalThis?"undefined"==typeof window?"undefined"==typeof global?"undefined"==typeof self?{}:self:global:window:globalThis,i=function(a,b,c){return c={path:b,exports:{},require:function(a,b){return g(a,b===void 0||null===b?c.path:b)}},a(c,c.exports),c.exports}(function(c){(function(d,a){c.exports=a()})(h,function(){return class{constructor(){const b=!!RTCRtpSender.prototype.createEncodedStreams;if(!b)throw new Error("E2EE is not supported in this browser.");this.worker=null,this.onWorkerDisconnect=null}startWorker(){const b=atob("InVzZSBzdHJpY3QiOwovKiBlc2xpbnQtZGlzYWJsZSBAdHlwZXNjcmlwdC1lc2xpbnQvbm8tdW51c2VkLXZhcnMgKi8KY29uc3QgY29ubmVjdGlvbklkTGVuZ3RoID0gMjY7CmZ1bmN0aW9uIGJ5dGVDb3VudChuKSB7CiAgICBpZiAobiA9PSAwKSB7CiAgICAgICAgcmV0dXJuIDE7CiAgICB9CiAgICAvLyBsb2cyNTYoeCkgPSBsb2coeCkgLyBsb2coMjU2KQogICAgcmV0dXJuIE1hdGguZmxvb3IoTWF0aC5sb2cobikgLyBNYXRoLmxvZygyICoqIDgpICsgMSk7Cn0KZnVuY3Rpb24gYXJyYXlCdWZmZXJUb051bWJlcihhcnJheUJ1ZmZlcikgewogICAgLy8gMzJiaXQg44G+44Gn44KS5oOz5a6aIChCaWdJbnQg44G444Gu5pu444GN5o+b44GI5pmC44Gr6KaB5L+u5q2jKQogICAgY29uc3QgbmV3QXJyYXlCdWZmZXIgPSBuZXcgQXJyYXlCdWZmZXIoVWludDMyQXJyYXkuQllURVNfUEVSX0VMRU1FTlQpOwogICAgY29uc3QgbmV3RGF0YVZpZXcgPSBuZXcgRGF0YVZpZXcobmV3QXJyYXlCdWZmZXIpOwogICAgY29uc3QgZGF0YVZpZXcgPSBuZXcgRGF0YVZpZXcoYXJyYXlCdWZmZXIpOwogICAgY29uc3QgcGFkZGluZ0xlbmd0aCA9IFVpbnQzMkFycmF5LkJZVEVTX1BFUl9FTEVNRU5UIC0gZGF0YVZpZXcuYnl0ZUxlbmd0aDsKICAgIGZvciAobGV0IGkgPSAwOyBpIDwgcGFkZGluZ0xlbmd0aDsgaSArPSAxKSB7CiAgICAgICAgbmV3RGF0YVZpZXcuc2V0VWludDgoaSwgMCk7CiAgICB9CiAgICBmb3IgKGxldCBpID0gcGFkZGluZ0xlbmd0aCwgaiA9IDA7IGkgPCBVaW50MzJBcnJheS5CWVRFU19QRVJfRUxFTUVOVDsgaSArPSAxLCBqICs9IDEpIHsKICAgICAgICBuZXdEYXRhVmlldy5zZXRVaW50OChpLCBkYXRhVmlldy5nZXRVaW50OChqKSk7CiAgICB9CiAgICByZXR1cm4gbmV3RGF0YVZpZXcuZ2V0VWludDMyKDApOwp9CmZ1bmN0aW9uIGVuY29kZVNGcmFtZUhlYWRlcihzLCBjb3VudCwga2V5SWQpIHsKICAgIC8vICAwIDEgMiAzIDQgNSA2IDcKICAgIC8vICstKy0rLSstKy0rLSstKy0rLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tKy0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLSsKICAgIC8vIHxTfExFTiAgfDF8S0xFTiB8ICAgS0lELi4uIChsZW5ndGg9S0xFTikgICAgfCAgICBDVFIuLi4gKGxlbmd0aD1MRU4pICAgIHwKICAgIC8vICstKy0rLSstKy0rLSstKy0rLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tKy0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLSsKICAgIC8vIFM6IDEgYml0CiAgICAvLyBMRU46IDMgYml0CiAgICAvLyBYOiAxIGJpdAogICAgLy8gS0xFTjogMyBiaXQKICAgIC8vIEtJRDogS0xFTiBieXRlCiAgICAvLyBDVFI6IExFTiBieXRlCiAgICAvLyBUT0RPOiBrZXlJZCAoS0lEKSDjgYwgTnVtYmVyLk1BWF9TQUZFX0lOVEVHRVIsIDcgYnl0ZSDjgpLotoXjgYjjgabjgYTjgZ/loLTlkIjjga/jgqjjg6njg7zjgYvkvovlpJYKICAgIC8vIFRPRE86IGNvdW50IChDVFIpIOOBjCBOdW1iZXIuTUFYX1NBRkVfSU5URUdFUiwgNyBieXRlIOOCkui2heOBiOOBpuOBhOOBn+WgtOWQiOOBr+OCqOODqeODvOOBi+S+i+WklgogICAgaWYgKG1heEtleUlkIDwga2V5SWQgfHwgbWF4Q291bnQgPCBjb3VudCkgewogICAgICAgIHRocm93IG5ldyBFcnJvcigiRVhDRUVERUQtTUFYSU1VTS1CUk9BRENBU1RJTkctVElNRSIpOwogICAgfQogICAgY29uc3Qga2xlbiA9IGJ5dGVDb3VudChrZXlJZCk7CiAgICBjb25zdCBsZW4gPSBieXRlQ291bnQoY291bnQpOwogICAgY29uc3QgaGVhZGVyQnVmZmVyID0gbmV3IEFycmF5QnVmZmVyKDEgKyBrbGVuICsgbGVuKTsKICAgIGNvbnN0IGhlYWRlckRhdGFWaWV3ID0gbmV3IERhdGFWaWV3KGhlYWRlckJ1ZmZlcik7CiAgICAvLyBTLCBMRU4sIDEsIEtMRU4g44GnIDEgYnl0ZQogICAgaGVhZGVyRGF0YVZpZXcuc2V0VWludDgoMCwgKHMgPDwgNykgKyAobGVuIDw8IDQpICsgKDEgPDwgMykgKyBrbGVuKTsKICAgIGNvbnN0IGhlYWRlclVpbnQ4QXJyYXkgPSBuZXcgVWludDhBcnJheShoZWFkZXJCdWZmZXIpOwogICAgY29uc3Qga2V5SWRCdWZmZXIgPSBuZXcgQXJyYXlCdWZmZXIoVWludDMyQXJyYXkuQllURVNfUEVSX0VMRU1FTlQpOwogICAgY29uc3Qga2V5SWREYXRhVmlldyA9IG5ldyBEYXRhVmlldyhrZXlJZEJ1ZmZlcik7CiAgICBrZXlJZERhdGFWaWV3LnNldFVpbnQzMigwLCBrZXlJZCk7CiAgICBjb25zdCBrZXlJZFVpbnQ4QXJyYXkgPSBuZXcgVWludDhBcnJheShrZXlJZEJ1ZmZlcik7CiAgICBoZWFkZXJVaW50OEFycmF5LnNldChrZXlJZFVpbnQ4QXJyYXkuc3ViYXJyYXkoVWludDMyQXJyYXkuQllURVNfUEVSX0VMRU1FTlQgLSBrbGVuKSwgMSk7CiAgICBjb25zdCBjb3VudEJ1ZmZlciA9IG5ldyBBcnJheUJ1ZmZlcihVaW50MzJBcnJheS5CWVRFU19QRVJfRUxFTUVOVCk7CiAgICBjb25zdCBjb3VudERhdGFWaWV3ID0gbmV3IERhdGFWaWV3KGNvdW50QnVmZmVyKTsKICAgIGNvdW50RGF0YVZpZXcuc2V0VWludDMyKDAsIGNvdW50KTsKICAgIGNvbnN0IGNvdW50VWludDhBcnJheSA9IG5ldyBVaW50OEFycmF5KGNvdW50QnVmZmVyKTsKICAgIGhlYWRlclVpbnQ4QXJyYXkuc2V0KGNvdW50VWludDhBcnJheS5zdWJhcnJheShVaW50MzJBcnJheS5CWVRFU19QRVJfRUxFTUVOVCAtIGxlbiksIGtsZW4gKyAxKTsKICAgIHJldHVybiBoZWFkZXJVaW50OEFycmF5Owp9CmZ1bmN0aW9uIHNwbGl0SGVhZGVyKHNmcmFtZSkgewogICAgY29uc3Qgc2ZyYW1lRGF0YVZpZXcgPSBuZXcgRGF0YVZpZXcoc2ZyYW1lKTsKICAgIGNvbnN0IGhlYWRlciA9IHNmcmFtZURhdGFWaWV3LmdldFVpbnQ4KDApOwogICAgY29uc3QgbGVuID0gKGhlYWRlciAmIDB4NzApID4+IDQ7CiAgICBjb25zdCBrbGVuID0gaGVhZGVyICYgMHgwNzsKICAgIGNvbnN0IHNmcmFtZUhlYWRlckxlbmd0aCA9IDEgKyBrbGVuICsgbGVuOwogICAgY29uc3Qgc2ZyYW1lSGVhZGVyID0gc2ZyYW1lLnNsaWNlKDAsIHNmcmFtZUhlYWRlckxlbmd0aCk7CiAgICBpZiAoc2ZyYW1lSGVhZGVyLmJ5dGVMZW5ndGggPCBzZnJhbWVIZWFkZXJMZW5ndGgpIHsKICAgICAgICB0aHJvdyBuZXcgRXJyb3IoIlVORVhQRUNURUQtU0ZSQU1FLUxFTkdUSCIpOwogICAgfQogICAgY29uc3QgY29ubmVjdGlvbklkID0gc2ZyYW1lLnNsaWNlKHNmcmFtZUhlYWRlckxlbmd0aCwgc2ZyYW1lSGVhZGVyTGVuZ3RoICsgY29ubmVjdGlvbklkTGVuZ3RoKTsKICAgIGNvbnN0IGVuY3J5cHRlZEZyYW1lID0gc2ZyYW1lLnNsaWNlKHNmcmFtZUhlYWRlckxlbmd0aCArIGNvbm5lY3Rpb25JZExlbmd0aCwgc2ZyYW1lLmJ5dGVMZW5ndGgpOwogICAgcmV0dXJuIFtzZnJhbWVIZWFkZXIsIGNvbm5lY3Rpb25JZCwgZW5jcnlwdGVkRnJhbWVdOwp9CmZ1bmN0aW9uIHBhcnNlU0ZyYW1lSGVhZGVyKHNmcmFtZUhlYWRlcikgewogICAgY29uc3Qgc2ZyYW1lSGVhZGVyRGF0YVZpZXcgPSBuZXcgRGF0YVZpZXcoc2ZyYW1lSGVhZGVyKTsKICAgIGNvbnN0IGhlYWRlciA9IHNmcmFtZUhlYWRlckRhdGFWaWV3LmdldFVpbnQ4KDApOwogICAgY29uc3QgcyA9IChoZWFkZXIgJiAweDgwKSA+PiA3OwogICAgY29uc3QgbGVuID0gKGhlYWRlciAmIDB4NzApID4+IDQ7CiAgICBjb25zdCB4ID0gKGhlYWRlciAmIDB4MDgpID4+IDM7CiAgICBjb25zdCBrbGVuID0gaGVhZGVyICYgMHgwNzsKICAgIC8vIHggZmxhZwogICAgaWYgKHggIT09IDEpIHsKICAgICAgICB0aHJvdyBuZXcgRXJyb3IoIlVORVhQRUNURUQtWC1GTEFHIik7CiAgICB9CiAgICBjb25zdCBoZWFkZXJMZW5ndGggPSAxICsga2xlbiArIGxlbjsKICAgIGlmIChzZnJhbWVIZWFkZXJEYXRhVmlldy5ieXRlTGVuZ3RoIDwgaGVhZGVyTGVuZ3RoKSB7CiAgICAgICAgdGhyb3cgbmV3IEVycm9yKCJVTkVYUEVDVEVELVNGUkFNRS1IRUFERVItTEVOR1RIIik7CiAgICB9CiAgICBjb25zdCBrZXlJZEJ1ZmZlciA9IHNmcmFtZUhlYWRlci5zbGljZSgxLCAxICsga2xlbik7CiAgICBjb25zdCBrZXlJZCA9IGFycmF5QnVmZmVyVG9OdW1iZXIoa2V5SWRCdWZmZXIpOwogICAgY29uc3QgY291bnRCdWZmZXIgPSBzZnJhbWVIZWFkZXIuc2xpY2UoMSArIGtsZW4sIGhlYWRlckxlbmd0aCk7CiAgICBjb25zdCBjb3VudCA9IGFycmF5QnVmZmVyVG9OdW1iZXIoY291bnRCdWZmZXIpOwogICAgcmV0dXJuIFtzLCBjb3VudCwga2V5SWRdOwp9Ci8qIGVzbGludC1kaXNhYmxlIEB0eXBlc2NyaXB0LWVzbGludC90cmlwbGUtc2xhc2gtcmVmZXJlbmNlLCBAdHlwZXNjcmlwdC1lc2xpbnQvbm8tdW51c2VkLXZhcnMgKi8KLy8vIDxyZWZlcmVuY2UgcGF0aD0iLi9zZnJhbWUudHMiLz4KLy8gVE9ETzog5omx44GG5pWw5YCk44GM5aSn44GN44GE566H5omA44Gn44GvIE51bWJlciDjgYvjgokgQmlnSW50IOOBq+e9ruOBjeaPm+OBiOOCiwovLyBUT0RPOiBCaWdJbnQg44Gr572u44GN5o+b44GI44KL6Zqb44Gr5aSJ5pu044GZ44KLCmNvbnN0IG1heEtleUlkID0gMiAqKiAzMjsKY29uc3QgbWF4Q291bnQgPSAyICoqIDMyOwpjb25zdCBzZWxmRGVyaXZlS2V5TWFwID0gbmV3IE1hcCgpOwpjb25zdCBjb3VudE1hcCA9IG5ldyBNYXAoKTsKY29uc3Qgd3JpdGVJVk1hcCA9IG5ldyBNYXAoKTsKY29uc3QgcmVtb3RlRGVyaXZlS2V5TWFwID0gbmV3IE1hcCgpOwpjb25zdCBsYXRlc3RSZW1vdGVLZXlJZE1hcCA9IG5ldyBNYXAoKTsKY29uc3QgbGl0dGxlRW5kaWFuID0gdHJ1ZTsKY29uc3QgYmlnRW5kaWFuID0gIWxpdHRsZUVuZGlhbjsKY29uc3QgdGV4dEVuY29kZXIgPSBuZXcgVGV4dEVuY29kZXIoKTsKY29uc3QgdGV4dERlY29kZXIgPSBuZXcgVGV4dERlY29kZXIoKTsKLy8gVlA4IOOBruOBvwovLyBUT0RPKG5ha2FpKTogVlA5IC8gQVYxIOOCguWwhuadpeeahOOBq+WvvuW/nOOCguiAg+OBiOOCiwpjb25zdCB1bmVuY3J5cHRlZEJ5dGVzID0gewogICAgLy8gSSDjg5Xjg6zjg7zjg6AKICAgIGtleTogMTAsCiAgICAvLyDpnZ4gSSDjg5Xjg6zjg7zjg6AKICAgIGRlbHRhOiAzLAogICAgLy8g44Kq44O844OH44Kj44KqCiAgICB1bmRlZmluZWQ6IDEsCn07CmZ1bmN0aW9uIGdldENvdW50KGNvbm5lY3Rpb25JZCkgewogICAgcmV0dXJuIGNvdW50TWFwLmdldChjb25uZWN0aW9uSWQpIHx8IDA7Cn0KZnVuY3Rpb24gc2V0Q291bnQoY29ubmVjdGlvbklkLCBjb3VudCkgewogICAgcmV0dXJuIGNvdW50TWFwLnNldChjb25uZWN0aW9uSWQsIGNvdW50KTsKfQpmdW5jdGlvbiBnZXRSZW1vdGVEZXJpdmVLZXkoY29ubmVjdGlvbklkLCBrZXlJZCkgewogICAgaWYgKCFyZW1vdGVEZXJpdmVLZXlNYXAuaGFzKGNvbm5lY3Rpb25JZCkpIHsKICAgICAgICB0aHJvdyBuZXcgRXJyb3IoIlJFTU9URS1ERVJJVkVLRVktTUFQLU5PVC1GT1VORCIpOwogICAgfQogICAgY29uc3QgZGVyaXZlS2V5TWFwID0gcmVtb3RlRGVyaXZlS2V5TWFwLmdldChjb25uZWN0aW9uSWQpOwogICAgaWYgKCFkZXJpdmVLZXlNYXApIHsKICAgICAgICByZXR1cm4gdW5kZWZpbmVkOwogICAgfQogICAgcmV0dXJuIGRlcml2ZUtleU1hcC5nZXQoa2V5SWQpOwp9CmZ1bmN0aW9uIHNldFJlbW90ZURlcml2ZUtleShjb25uZWN0aW9uSWQsIGtleUlkLCBkZXJpdmVLZXkpIHsKICAgIGxldCBkZXJpdmVLZXlNYXAgPSByZW1vdGVEZXJpdmVLZXlNYXAuZ2V0KGNvbm5lY3Rpb25JZCk7CiAgICBpZiAoIWRlcml2ZUtleU1hcCkgewogICAgICAgIGRlcml2ZUtleU1hcCA9IG5ldyBNYXAoKTsKICAgIH0KICAgIGRlcml2ZUtleU1hcC5zZXQoa2V5SWQsIGRlcml2ZUtleSk7CiAgICByZW1vdGVEZXJpdmVLZXlNYXAuc2V0KGNvbm5lY3Rpb25JZCwgZGVyaXZlS2V5TWFwKTsKfQpmdW5jdGlvbiBzZXRMYXRlc3RSZW1vdGVLZXlJZChjb25uZWN0aW9uSWQsIGtleUlkKSB7CiAgICBjb25zdCBsYXRlc3RSZW1vdGVLZXlJZCA9IGxhdGVzdFJlbW90ZUtleUlkTWFwLmdldChjb25uZWN0aW9uSWQpOwogICAgaWYgKGxhdGVzdFJlbW90ZUtleUlkKSB7CiAgICAgICAgaWYgKGxhdGVzdFJlbW90ZUtleUlkIDwga2V5SWQpIHsKICAgICAgICAgICAgbGF0ZXN0UmVtb3RlS2V5SWRNYXAuc2V0KGNvbm5lY3Rpb25JZCwga2V5SWQpOwogICAgICAgIH0KICAgIH0KICAgIGVsc2UgewogICAgICAgIGxhdGVzdFJlbW90ZUtleUlkTWFwLnNldChjb25uZWN0aW9uSWQsIGtleUlkKTsKICAgIH0KfQpmdW5jdGlvbiByZW1vdmVPbGRSZW1vdGVEZXJpdmVLZXlzKCkgewogICAgbGF0ZXN0UmVtb3RlS2V5SWRNYXAuZm9yRWFjaCgobGF0ZXN0S2V5SWQsIGNvbm5lY3Rpb25JZCkgPT4gewogICAgICAgIGNvbnN0IGRlcml2ZUtleU1hcCA9IHJlbW90ZURlcml2ZUtleU1hcC5nZXQoY29ubmVjdGlvbklkKTsKICAgICAgICBpZiAoZGVyaXZlS2V5TWFwKSB7CiAgICAgICAgICAgIGRlcml2ZUtleU1hcC5mb3JFYWNoKChfLCBrZXlJZCkgPT4gewogICAgICAgICAgICAgICAgaWYgKGxhdGVzdEtleUlkICE9PSBrZXlJZCkgewogICAgICAgICAgICAgICAgICAgIGRlcml2ZUtleU1hcC5kZWxldGUoa2V5SWQpOwogICAgICAgICAgICAgICAgfQogICAgICAgICAgICB9KTsKICAgICAgICB9CiAgICB9KTsKfQpmdW5jdGlvbiByZW1vdmVEZXJpdmVLZXkoY29ubmVjdGlvbklkKSB7CiAgICBsYXRlc3RSZW1vdGVLZXlJZE1hcC5kZWxldGUoY29ubmVjdGlvbklkKTsKICAgIHJlbW90ZURlcml2ZUtleU1hcC5kZWxldGUoY29ubmVjdGlvbklkKTsKfQpmdW5jdGlvbiBnZXRMYXRlc3RTZWxmRGVyaXZlS2V5KCkgewogICAgY29uc3QgZGVyaXZlS2V5ID0gc2VsZkRlcml2ZUtleU1hcC5nZXQoImxhdGVzdCIpOwogICAgaWYgKCFkZXJpdmVLZXkpIHsKICAgICAgICB0aHJvdyBuZXcgRXJyb3IoIkxBVEVTVC1TRUxGLURFUklWRUtFWS1OT1RfRk9VTkQiKTsKICAgIH0KICAgIHJldHVybiBkZXJpdmVLZXk7Cn0KZnVuY3Rpb24gc2V0U2VsZkRlcml2ZUtleShjb25uZWN0aW9uSWQsIGtleUlkLCBkZXJpdmVLZXkpIHsKICAgIGNvbnN0IGN1cnJlbnRTZWxmRGVyaXZlS2V5ID0gc2VsZkRlcml2ZUtleU1hcC5nZXQoImxhdGVzdCIpOwogICAgaWYgKGN1cnJlbnRTZWxmRGVyaXZlS2V5KSB7CiAgICAgICAgaWYgKGN1cnJlbnRTZWxmRGVyaXZlS2V5WyJrZXlJZCJdIDwga2V5SWQpIHsKICAgICAgICAgICAgY29uc3QgbmV4dFNlbGZEZXJpdmVLZXkgPSB7IGNvbm5lY3Rpb25JZCwga2V5SWQsIGRlcml2ZUtleSB9OwogICAgICAgICAgICBzZWxmRGVyaXZlS2V5TWFwLnNldCgibGF0ZXN0IiwgbmV4dFNlbGZEZXJpdmVLZXkpOwogICAgICAgIH0KICAgIH0KICAgIGVsc2UgewogICAgICAgIGNvbnN0IG5leHRTZWxmRGVyaXZlS2V5ID0geyBjb25uZWN0aW9uSWQsIGtleUlkLCBkZXJpdmVLZXkgfTsKICAgICAgICBzZWxmRGVyaXZlS2V5TWFwLnNldCgibGF0ZXN0IiwgbmV4dFNlbGZEZXJpdmVLZXkpOwogICAgfQp9CmZ1bmN0aW9uIHNpbGVuY2VGcmFtZShlbmNvZGVkRnJhbWUpIHsKICAgIC8vIGNvbm5lY3Rpb24uY3JlYXRlZCwgcmVjZWl2ZU1lc3NhZ2Ug5Y+X5L+h5YmN44Gu5aC05ZCICiAgICBpZiAoZW5jb2RlZEZyYW1lLnR5cGUgPT09IHVuZGVmaW5lZCkgewogICAgICAgIC8vIOmfs+WjsOOBr+aal+WPt+WMluOBr+OBhOOCi+OBqOiBnuOBkeOBn+OCguOBruOBmOOCg+OBquOBhOOBruOBp+e9ruOBjeaPm+OBiOOCiwogICAgICAgIGNvbnN0IG5ld0RhdGEgPSBuZXcgQXJyYXlCdWZmZXIoMyk7CiAgICAgICAgY29uc3QgbmV3VWludDggPSBuZXcgVWludDhBcnJheShuZXdEYXRhKTsKICAgICAgICAvLyBPcHVzIOOCteOCpOODrOODs+OCueODleODrOODvOODoAogICAgICAgIG5ld1VpbnQ4LnNldChbMHhkOCwgMHhmZiwgMHhmZV0pOwogICAgICAgIGVuY29kZWRGcmFtZS5kYXRhID0gbmV3RGF0YTsKICAgIH0KICAgIGVsc2UgewogICAgICAgIC8vIOaYoOWDj+OBjOato+W4uOOBmOOCg+OBquOBhOOBn+OCgSBQTEkg44K544OI44O844Og44GM55m655Sf44GX44Gm44GX44G+44GGCiAgICAgICAgLy8g44Gd44Gu44Gf44KBIDMyMHgyNDAg44Gu55yf44Gj6buS44Gq55S76Z2i44Gr572u44GN5o+b44GI44KLCiAgICAgICAgY29uc3QgbmV3RGF0YSA9IG5ldyBBcnJheUJ1ZmZlcig2MCk7CiAgICAgICAgY29uc3QgbmV3VWludDggPSBuZXcgVWludDhBcnJheShuZXdEYXRhKTsKICAgICAgICAvLyBwcmV0dGllci1pZ25vcmUKICAgICAgICBuZXdVaW50OC5zZXQoWzB4YjAsIDB4MDUsIDB4MDAsIDB4OWQsIDB4MDEsIDB4MmEsIDB4YTAsIDB4MDAsIDB4NWEsIDB4MDAsCiAgICAgICAgICAgIDB4MzksIDB4MDMsIDB4MDAsIDB4MDAsIDB4MWMsIDB4MjIsIDB4MTYsIDB4MTYsIDB4MjIsIDB4NjYsCiAgICAgICAgICAgIDB4MTIsIDB4MjAsIDB4MDQsIDB4OTAsIDB4NDAsIDB4MDAsIDB4YzUsIDB4MDEsIDB4ZTAsIDB4N2MsCiAgICAgICAgICAgIDB4NGQsIDB4MmYsIDB4ZmEsIDB4ZGQsIDB4NGQsIDB4YTUsIDB4N2YsIDB4ODksIDB4YTUsIDB4ZmYsCiAgICAgICAgICAgIDB4NWIsIDB4YTksIDB4YjQsIDB4YWYsIDB4ZjEsIDB4MzQsIDB4YmYsIDB4ZWIsIDB4NzUsIDB4MzYsCiAgICAgICAgICAgIDB4OTUsIDB4ZmUsIDB4MjYsIDB4OTYsIDB4NjAsIDB4ZmUsIDB4ZmYsIDB4YmEsIDB4ZmYsIDB4NDAsCiAgICAgICAgXSk7CiAgICAgICAgZW5jb2RlZEZyYW1lLmRhdGEgPSBuZXdEYXRhOwogICAgfQogICAgcmV0dXJuIGVuY29kZWRGcmFtZTsKfQpmdW5jdGlvbiBzZXRXcml0ZUlWKGNvbm5lY3Rpb25JZCwga2V5SWQsIHdyaXRlSVYpIHsKICAgIGNvbnN0IGtleSA9IFtjb25uZWN0aW9uSWQsIGtleUlkLnRvU3RyaW5nKCldLmpvaW4oIjoiKTsKICAgIHdyaXRlSVZNYXAuc2V0KGtleSwgd3JpdGVJVik7Cn0KZnVuY3Rpb24gZ2V0V3JpdGVJVihjb25uZWN0aW9uSWQsIGtleUlkKSB7CiAgICBjb25zdCBrZXkgPSBbY29ubmVjdGlvbklkLCBrZXlJZC50b1N0cmluZygpXS5qb2luKCI6Iik7CiAgICByZXR1cm4gd3JpdGVJVk1hcC5nZXQoa2V5KTsKfQpmdW5jdGlvbiBnZW5lcmF0ZUlWKGNvdW50LCBjb25uZWN0aW9uSWQsIGtleUlkKSB7CiAgICAvLyBUT0RPOiBrZXlJZCDjgYwgTnVtYmVyLk1BWF9TQUZFX0lOVEVHRVIsIDcgYnl0ZSDjgpLotoXjgYjjgabjgYTjgZ/loLTlkIjjga/jgqjjg6njg7zjgYvkvovlpJYKICAgIC8vIFRPRE86IGNvdW50IOOBjCBOdW1iZXIuTUFYX1NBRkVfSU5URUdFUiwgNyBieXRlIOOCkui2heOBiOOBpuOBhOOBn+WgtOWQiOOBr+OCqOODqeODvOOBi+S+i+WklgogICAgLy8gMzIgYml0IOOBvuOBpwogICAgaWYgKG1heEtleUlkIDwga2V5SWQgfHwgbWF4Q291bnQgPCBjb3VudCkgewogICAgICAgIHRocm93IG5ldyBFcnJvcigiRVhDRUVERUQtTUFYSU1VTS1CUk9BRENBU1RJTkctVElNRSIpOwogICAgfQogICAgY29uc3Qgd3JpdGVJViA9IGdldFdyaXRlSVYoY29ubmVjdGlvbklkLCBrZXlJZCk7CiAgICBpZiAoIXdyaXRlSVYpIHsKICAgICAgICB0aHJvdyBuZXcgRXJyb3IoIldSSVRFSVYtTk9ULUZPVU5EIik7CiAgICB9CiAgICBjb25zdCBwYWRkaW5nTGVuZ3RoID0gTm4gLSBVaW50MzJBcnJheS5CWVRFU19QRVJfRUxFTUVOVDsKICAgIGNvbnN0IGNvdW50V2l0aFBhZGRpbmdCdWZmZXIgPSBuZXcgQXJyYXlCdWZmZXIoTm4pOwogICAgY29uc3QgY291bnRXaXRoUGFkZGluZ0RhdGFWaWV3ID0gbmV3IERhdGFWaWV3KGNvdW50V2l0aFBhZGRpbmdCdWZmZXIpOwogICAgY291bnRXaXRoUGFkZGluZ0RhdGFWaWV3LnNldFVpbnQzMihwYWRkaW5nTGVuZ3RoLCBjb3VudCwgYmlnRW5kaWFuKTsKICAgIGNvbnN0IGl2ID0gbmV3IFVpbnQ4QXJyYXkoTm4pOwogICAgY29uc3QgY291bnRXaXRoUGFkZGluZyA9IG5ldyBVaW50OEFycmF5KGNvdW50V2l0aFBhZGRpbmdCdWZmZXIpOwogICAgZm9yIChsZXQgaSA9IDA7IGkgPCBObjsgaSsrKSB7CiAgICAgICAgaXZbaV0gPSB3cml0ZUlWW2ldIF4gY291bnRXaXRoUGFkZGluZ1tpXTsKICAgIH0KICAgIHJldHVybiBpdjsKfQpmdW5jdGlvbiBwYXJzZVBheWxvYWQocGF5bG9hZFR5cGUsIHBheWxvYWQpIHsKICAgIHJldHVybiBbCiAgICAgICAgbmV3IFVpbnQ4QXJyYXkocGF5bG9hZCwgMCwgdW5lbmNyeXB0ZWRCeXRlc1twYXlsb2FkVHlwZV0pLAogICAgICAgIG5ldyBVaW50OEFycmF5KHBheWxvYWQsIHVuZW5jcnlwdGVkQnl0ZXNbcGF5bG9hZFR5cGVdKSwKICAgIF07Cn0KZnVuY3Rpb24gZW5jb2RlRnJhbWVBZGQoaGVhZGVyLCBzZnJhbWVIZWFkZXIsIGNvbm5lY3Rpb25JZCkgewogICAgY29uc3QgY29ubmVjdGlvbklkRGF0YSA9IHRleHRFbmNvZGVyLmVuY29kZShjb25uZWN0aW9uSWQpOwogICAgY29uc3QgZnJhbWVBZGQgPSBuZXcgVWludDhBcnJheShoZWFkZXIuYnl0ZUxlbmd0aCArIHNmcmFtZUhlYWRlci5ieXRlTGVuZ3RoICsgY29ubmVjdGlvbklkRGF0YS5ieXRlTGVuZ3RoKTsKICAgIGZyYW1lQWRkLnNldChoZWFkZXIsIDApOwogICAgZnJhbWVBZGQuc2V0KHNmcmFtZUhlYWRlciwgaGVhZGVyLmJ5dGVMZW5ndGgpOwogICAgZnJhbWVBZGQuc2V0KGNvbm5lY3Rpb25JZERhdGEsIGhlYWRlci5ieXRlTGVuZ3RoICsgc2ZyYW1lSGVhZGVyLmJ5dGVMZW5ndGgpOwogICAgcmV0dXJuIGZyYW1lQWRkOwp9CmFzeW5jIGZ1bmN0aW9uIGVuY3J5cHRGdW5jdGlvbihlbmNvZGVkRnJhbWUsIGNvbnRyb2xsZXIpIHsKICAgIGNvbnN0IHsgY29ubmVjdGlvbklkLCBrZXlJZCwgZGVyaXZlS2V5IH0gPSBnZXRMYXRlc3RTZWxmRGVyaXZlS2V5KCk7CiAgICBpZiAoIWRlcml2ZUtleSkgewogICAgICAgIGNvbnNvbGUuaW5mbygiREVSSVZFS0VZLU5PVC1GT1VORCIpOwogICAgICAgIHJldHVybjsKICAgIH0KICAgIGNvbnN0IGN1cnJlbnRDb3VudCA9IGdldENvdW50KGNvbm5lY3Rpb25JZCk7CiAgICAvLyBjb3VudCDjgYwgMzIgYml0IOS7peS4iuOBruWgtOWQiOOBr+WBnOatouOBmeOCiwogICAgaWYgKGN1cnJlbnRDb3VudCA+IG1heENvdW50KSB7CiAgICAgICAgcG9zdE1lc3NhZ2UoeyB0eXBlOiAiZGlzY29ubmVjdCIgfSk7CiAgICB9CiAgICBjb25zdCBpdiA9IGdlbmVyYXRlSVYoY3VycmVudENvdW50LCBjb25uZWN0aW9uSWQsIGtleUlkKTsKICAgIGlmICghaXYpIHsKICAgICAgICBjb25zb2xlLmluZm8oIldSSVRFSVYtTk9ULUZPVU5EIik7CiAgICAgICAgcmV0dXJuOwogICAgfQogICAgY29uc3QgW2hlYWRlciwgcGF5bG9hZF0gPSBwYXJzZVBheWxvYWQoZW5jb2RlZEZyYW1lLnR5cGUsIGVuY29kZWRGcmFtZS5kYXRhKTsKICAgIGNvbnN0IHNmcmFtZUhlYWRlciA9IGVuY29kZVNGcmFtZUhlYWRlcigwLCBjdXJyZW50Q291bnQsIGtleUlkKTsKICAgIGNvbnN0IGZyYW1lQWRkID0gZW5jb2RlRnJhbWVBZGQoaGVhZGVyLCBzZnJhbWVIZWFkZXIsIGNvbm5lY3Rpb25JZCk7CiAgICBjcnlwdG8uc3VidGxlCiAgICAgICAgLmVuY3J5cHQoewogICAgICAgIG5hbWU6ICJBRVMtR0NNIiwKICAgICAgICBpdjogaXYsCiAgICAgICAgLy8g5pqX5Y+35YyW44GV44KM44Gm44GE44Gq44GE6YOo5YiGCiAgICAgICAgYWRkaXRpb25hbERhdGE6IGZyYW1lQWRkLAogICAgfSwgZGVyaXZlS2V5LCBwYXlsb2FkKQogICAgICAgIC50aGVuKChjaXBoZXJUZXh0KSA9PiB7CiAgICAgICAgY29uc3QgbmV3RGF0YSA9IG5ldyBBcnJheUJ1ZmZlcihmcmFtZUFkZC5ieXRlTGVuZ3RoICsgY2lwaGVyVGV4dC5ieXRlTGVuZ3RoKTsKICAgICAgICBjb25zdCBuZXdEYXRhVWludDggPSBuZXcgVWludDhBcnJheShuZXdEYXRhKTsKICAgICAgICBuZXdEYXRhVWludDguc2V0KGZyYW1lQWRkLCAwKTsKICAgICAgICBuZXdEYXRhVWludDguc2V0KG5ldyBVaW50OEFycmF5KGNpcGhlclRleHQpLCBmcmFtZUFkZC5ieXRlTGVuZ3RoKTsKICAgICAgICBlbmNvZGVkRnJhbWUuZGF0YSA9IG5ld0RhdGE7CiAgICAgICAgY29udHJvbGxlci5lbnF1ZXVlKGVuY29kZWRGcmFtZSk7CiAgICB9KTsKICAgIHNldENvdW50KGNvbm5lY3Rpb25JZCwgY3VycmVudENvdW50ICsgMSk7Cn0KYXN5bmMgZnVuY3Rpb24gZGVjcnlwdEZ1bmN0aW9uKGVuY29kZWRGcmFtZSwgY29udHJvbGxlcikgewogICAgLy8g56m644OV44Os44O844Og5a++5b+cCiAgICBpZiAoZW5jb2RlZEZyYW1lLmRhdGEuYnl0ZUxlbmd0aCA8IDEpIHsKICAgICAgICBjb25zb2xlLmluZm8oIkVNUFRZLURBVEEiKTsKICAgICAgICByZXR1cm47CiAgICB9CiAgICB0cnkgewogICAgICAgIGNvbnN0IGZyYW1lTWV0YWRhdGFCdWZmZXIgPSBlbmNvZGVkRnJhbWUuZGF0YS5zbGljZSgwLCB1bmVuY3J5cHRlZEJ5dGVzW2VuY29kZWRGcmFtZS50eXBlXSk7CiAgICAgICAgY29uc3QgZnJhbWVNZXRhZGF0YSA9IG5ldyBVaW50OEFycmF5KGZyYW1lTWV0YWRhdGFCdWZmZXIpOwogICAgICAgIGNvbnN0IFtzZnJhbWVIZWFkZXJCdWZmZXIsIGNvbm5lY3Rpb25JZEJ1ZmZlciwgZW5jcnlwdGVkRnJhbWVCdWZmZXJdID0gc3BsaXRIZWFkZXIoZW5jb2RlZEZyYW1lLmRhdGEuc2xpY2UodW5lbmNyeXB0ZWRCeXRlc1tlbmNvZGVkRnJhbWUudHlwZV0pKTsKICAgICAgICBjb25zdCBzZnJhbWVIZWFkZXIgPSBuZXcgVWludDhBcnJheShzZnJhbWVIZWFkZXJCdWZmZXIpOwogICAgICAgIGNvbnN0IGNvbm5lY3Rpb25JZCA9IHRleHREZWNvZGVyLmRlY29kZShjb25uZWN0aW9uSWRCdWZmZXIpOwogICAgICAgIGNvbnN0IFtzLCBjb3VudCwga2V5SWRdID0gcGFyc2VTRnJhbWVIZWFkZXIoc2ZyYW1lSGVhZGVyQnVmZmVyKTsKICAgICAgICAvLyDku4rlm57jga8gcyBmbGFnIOOBryAwIOOBruOBvwogICAgICAgIGlmIChzICE9PSAwKSB7CiAgICAgICAgICAgIHRocm93IG5ldyBFcnJvcigiVU5FWFBFQ1RFRC1TLUZMQUciKTsKICAgICAgICB9CiAgICAgICAgY29uc3QgZGVyaXZlS2V5ID0gZ2V0UmVtb3RlRGVyaXZlS2V5KGNvbm5lY3Rpb25JZCwga2V5SWQpOwogICAgICAgIGlmICghZGVyaXZlS2V5KSB7CiAgICAgICAgICAgIGNvbnNvbGUud2FybigiREVSSVZFS0VZLU5PVC1GT1VORDogIiwgY29ubmVjdGlvbklkLCBrZXlJZCk7CiAgICAgICAgICAgIHJldHVybjsKICAgICAgICB9CiAgICAgICAgY29uc3QgaXYgPSBnZW5lcmF0ZUlWKGNvdW50LCBjb25uZWN0aW9uSWQsIGtleUlkKTsKICAgICAgICBpZiAoIWl2KSB7CiAgICAgICAgICAgIGNvbnNvbGUuaW5mbygiV1JJVEVJVi1OT1QtRk9VTkQiKTsKICAgICAgICAgICAgcmV0dXJuOwogICAgICAgIH0KICAgICAgICBjb25zdCBmcmFtZUFkZCA9IGVuY29kZUZyYW1lQWRkKGZyYW1lTWV0YWRhdGEsIHNmcmFtZUhlYWRlciwgY29ubmVjdGlvbklkKTsKICAgICAgICBjcnlwdG8uc3VidGxlCiAgICAgICAgICAgIC5kZWNyeXB0KHsKICAgICAgICAgICAgbmFtZTogIkFFUy1HQ00iLAogICAgICAgICAgICBpdjogaXYsCiAgICAgICAgICAgIGFkZGl0aW9uYWxEYXRhOiBmcmFtZUFkZCwKICAgICAgICB9LCBkZXJpdmVLZXksIG5ldyBVaW50OEFycmF5KGVuY3J5cHRlZEZyYW1lQnVmZmVyKSkKICAgICAgICAgICAgLnRoZW4oKHBsYWluVGV4dCkgPT4gewogICAgICAgICAgICBjb25zdCBuZXdEYXRhID0gbmV3IEFycmF5QnVmZmVyKGZyYW1lTWV0YWRhdGFCdWZmZXIuYnl0ZUxlbmd0aCArIHBsYWluVGV4dC5ieXRlTGVuZ3RoKTsKICAgICAgICAgICAgY29uc3QgbmV3VWludDggPSBuZXcgVWludDhBcnJheShuZXdEYXRhKTsKICAgICAgICAgICAgbmV3VWludDguc2V0KG5ldyBVaW50OEFycmF5KGZyYW1lTWV0YWRhdGFCdWZmZXIsIDAsIHVuZW5jcnlwdGVkQnl0ZXNbZW5jb2RlZEZyYW1lLnR5cGVdKSk7CiAgICAgICAgICAgIG5ld1VpbnQ4LnNldChuZXcgVWludDhBcnJheShwbGFpblRleHQpLCB1bmVuY3J5cHRlZEJ5dGVzW2VuY29kZWRGcmFtZS50eXBlXSk7CiAgICAgICAgICAgIGVuY29kZWRGcmFtZS5kYXRhID0gbmV3RGF0YTsKICAgICAgICAgICAgY29udHJvbGxlci5lbnF1ZXVlKGVuY29kZWRGcmFtZSk7CiAgICAgICAgfSk7CiAgICB9CiAgICBjYXRjaCAoZSkgewogICAgICAgIC8vIOaDs+WumuWkluOBruODkeOCseODg+ODiOODleOCqeODvOODnuODg+ODiOOCkuWPl+S/oeOBl+OBn+WgtOWQiAogICAgICAgIGNvbnRyb2xsZXIuZW5xdWV1ZShzaWxlbmNlRnJhbWUoZW5jb2RlZEZyYW1lKSk7CiAgICB9Cn0KLyogZXNsaW50LWRpc2FibGUgQHR5cGVzY3JpcHQtZXNsaW50L3RyaXBsZS1zbGFzaC1yZWZlcmVuY2UgKi8KLy8vIDxyZWZlcmVuY2UgcGF0aD0iLi9lMmVlLnRzIi8+Ci8vIG5vbmNlIOOCteOCpOOCugpjb25zdCBObiA9IDEyOwovLyBrZXkg44K144Kk44K6CmNvbnN0IE5rID0gMTY7Ci8vIGtleSDjgrXjgqTjgrrvvIhiaXTvvIkKY29uc3Qga2V5TGVuZ3RoID0gTmsgKiA4Owphc3luYyBmdW5jdGlvbiBnZW5lcmF0ZURlcml2ZUtleShtYXRlcmlhbCkgewogICAgY29uc3Qgc2FsdCA9IHRleHRFbmNvZGVyLmVuY29kZSgiU0ZyYW1lMTAiKTsKICAgIGNvbnN0IGluZm8gPSB0ZXh0RW5jb2Rlci5lbmNvZGUoImtleSIpOwogICAgY29uc3QgZGVyaXZlS2V5ID0gYXdhaXQgY3J5cHRvLnN1YnRsZS5kZXJpdmVLZXkoewogICAgICAgIG5hbWU6ICJIS0RGIiwKICAgICAgICBzYWx0OiBzYWx0LAogICAgICAgIGhhc2g6ICJTSEEtMjU2IiwKICAgICAgICBpbmZvOiBpbmZvLAogICAgfSwgbWF0ZXJpYWwsIHsKICAgICAgICBuYW1lOiAiQUVTLUdDTSIsCiAgICAgICAgbGVuZ3RoOiBrZXlMZW5ndGgsCiAgICB9LCBmYWxzZSwgWyJlbmNyeXB0IiwgImRlY3J5cHQiXSk7CiAgICByZXR1cm4gZGVyaXZlS2V5Owp9CmFzeW5jIGZ1bmN0aW9uIGdlbmVyYXRlV3JpdGVJVihtYXRlcmlhbCkgewogICAgY29uc3Qgc2FsdCA9IHRleHRFbmNvZGVyLmVuY29kZSgiU0ZyYW1lMTAiKTsKICAgIGNvbnN0IGluZm8gPSB0ZXh0RW5jb2Rlci5lbmNvZGUoInNhbHQiKTsKICAgIGNvbnN0IHdyaXRlSVZCdWZmZXIgPSBhd2FpdCBjcnlwdG8uc3VidGxlLmRlcml2ZUJpdHMoewogICAgICAgIG5hbWU6ICJIS0RGIiwKICAgICAgICBzYWx0OiBzYWx0LAogICAgICAgIGhhc2g6ICJTSEEtMzg0IiwKICAgICAgICBpbmZvOiBpbmZvLAogICAgfSwgbWF0ZXJpYWwsIAogICAgLy8gSVYg44GvIDk2IOODk+ODg+ODiOOBquOBruOBpwogICAgTm4gKiA4KTsKICAgIGNvbnN0IHdyaXRlSVYgPSBuZXcgVWludDhBcnJheSh3cml0ZUlWQnVmZmVyKTsKICAgIHJldHVybiB3cml0ZUlWOwp9CmxldCByZW1vdmFsVGltZW91dElkID0gMDsKb25tZXNzYWdlID0gKGV2ZW50KSA9PiB7CiAgICBjb25zdCB7IHR5cGUgfSA9IGV2ZW50LmRhdGE7CiAgICBpZiAodHlwZSA9PT0gInNlbGZTZWNyZXRLZXlNYXRlcmlhbCIpIHsKICAgICAgICBjb25zdCB7IHNlbGZTZWNyZXRLZXlNYXRlcmlhbCwgc2VsZkNvbm5lY3Rpb25JZCwgc2VsZktleUlkLCB3YWl0aW5nVGltZSB9ID0gZXZlbnQuZGF0YTsKICAgICAgICBjb25zdCB0aW1lb3V0SWQgPSBzZXRUaW1lb3V0KCgpID0+IHsKICAgICAgICAgICAgY3J5cHRvLnN1YnRsZQogICAgICAgICAgICAgICAgLmltcG9ydEtleSgicmF3Iiwgc2VsZlNlY3JldEtleU1hdGVyaWFsLmJ1ZmZlciwgIkhLREYiLCBmYWxzZSwgWyJkZXJpdmVCaXRzIiwgImRlcml2ZUtleSJdKQogICAgICAgICAgICAgICAgLnRoZW4oKG1hdGVyaWFsKSA9PiB7CiAgICAgICAgICAgICAgICBnZW5lcmF0ZURlcml2ZUtleShtYXRlcmlhbCkudGhlbigoZGVyaXZlS2V5KSA9PiB7CiAgICAgICAgICAgICAgICAgICAgc2V0U2VsZkRlcml2ZUtleShzZWxmQ29ubmVjdGlvbklkLCBzZWxmS2V5SWQsIGRlcml2ZUtleSk7CiAgICAgICAgICAgICAgICB9KTsKICAgICAgICAgICAgICAgIGdlbmVyYXRlV3JpdGVJVihtYXRlcmlhbCkudGhlbigod3JpdGVJVikgPT4gewogICAgICAgICAgICAgICAgICAgIHNldFdyaXRlSVYoc2VsZkNvbm5lY3Rpb25JZCwgc2VsZktleUlkLCB3cml0ZUlWKTsKICAgICAgICAgICAgICAgIH0pOwogICAgICAgICAgICAgICAgY2xlYXJUaW1lb3V0KHRpbWVvdXRJZCk7CiAgICAgICAgICAgIH0pOwogICAgICAgIH0sIHdhaXRpbmdUaW1lIHx8IDApOwogICAgICAgIC8vIFRPRE86ICsxMDAwIOOBp+mNteeUn+aIkOW+jOOBq+Wun+ihjOOBleOCjOOCi+OCiOOBhuOBq+OBl+OBpuOBhOOCi+OBjOefreOBhOWgtOWQiOOBr+S8uOOBsOOBmQogICAgICAgIGNvbnN0IHJlbW92YWxXYWl0aW5nVGltZSA9ICh3YWl0aW5nVGltZSB8fCAwKSArIDEwMDA7CiAgICAgICAgaWYgKHJlbW92YWxUaW1lb3V0SWQpIHsKICAgICAgICAgICAgLy8g5YuV5L2c5riI44G/44K/44Kk44Oe44O85pyJ44KKCiAgICAgICAgICAgIGlmICh3YWl0aW5nVGltZSkgewogICAgICAgICAgICAgICAgLy8gY29ubmVjdGlvbi5kZXN0cm95ZWQKICAgICAgICAgICAgICAgIGNsZWFyVGltZW91dChyZW1vdmFsVGltZW91dElkKTsKICAgICAgICAgICAgICAgIHJlbW92YWxUaW1lb3V0SWQgPSBzZXRUaW1lb3V0KCgpID0+IHsKICAgICAgICAgICAgICAgICAgICByZW1vdmVPbGRSZW1vdGVEZXJpdmVLZXlzKCk7CiAgICAgICAgICAgICAgICAgICAgY2xlYXJUaW1lb3V0KHJlbW92YWxUaW1lb3V0SWQpOwogICAgICAgICAgICAgICAgICAgIHJlbW92YWxUaW1lb3V0SWQgPSAwOwogICAgICAgICAgICAgICAgfSwgcmVtb3ZhbFdhaXRpbmdUaW1lKTsKICAgICAgICAgICAgfQogICAgICAgIH0KICAgICAgICBlbHNlIHsKICAgICAgICAgICAgLy8g5YuV5L2c5riI44G/44K/44Kk44Oe44O844Gq44GXCiAgICAgICAgICAgIC8vIGNvbm5lY3Rpb24uY3JlYXRlZCDjga7loLTlkIjjgoLlsJHjgZflrp/ooYzjgpLpgYXjgonjgZvjgosKICAgICAgICAgICAgcmVtb3ZhbFRpbWVvdXRJZCA9IHNldFRpbWVvdXQoKCkgPT4gewogICAgICAgICAgICAgICAgcmVtb3ZlT2xkUmVtb3RlRGVyaXZlS2V5cygpOwogICAgICAgICAgICAgICAgY2xlYXJUaW1lb3V0KHJlbW92YWxUaW1lb3V0SWQpOwogICAgICAgICAgICAgICAgcmVtb3ZhbFRpbWVvdXRJZCA9IDA7CiAgICAgICAgICAgIH0sIHJlbW92YWxXYWl0aW5nVGltZSk7CiAgICAgICAgfQogICAgfQogICAgZWxzZSBpZiAodHlwZSA9PT0gInJlbW90ZVNlY3JldEtleU1hdGVyaWFscyIpIHsKICAgICAgICBjb25zdCB7IHJlbW90ZVNlY3JldEtleU1hdGVyaWFscyB9ID0gZXZlbnQuZGF0YTsKICAgICAgICBmb3IgKGNvbnN0IFtjb25uZWN0aW9uSWQsIHJlbW90ZVNlY3JldEtleU1hdGVyaWFsXSBvZiBPYmplY3QuZW50cmllcyhyZW1vdGVTZWNyZXRLZXlNYXRlcmlhbHMpKSB7CiAgICAgICAgICAgIGNvbnN0IHsga2V5SWQsIHNlY3JldEtleU1hdGVyaWFsIH0gPSByZW1vdGVTZWNyZXRLZXlNYXRlcmlhbDsKICAgICAgICAgICAgY3J5cHRvLnN1YnRsZQogICAgICAgICAgICAgICAgLmltcG9ydEtleSgicmF3Iiwgc2VjcmV0S2V5TWF0ZXJpYWwuYnVmZmVyLCAiSEtERiIsIGZhbHNlLCBbImRlcml2ZUJpdHMiLCAiZGVyaXZlS2V5Il0pCiAgICAgICAgICAgICAgICAudGhlbigobWF0ZXJpYWwpID0+IHsKICAgICAgICAgICAgICAgIGdlbmVyYXRlRGVyaXZlS2V5KG1hdGVyaWFsKS50aGVuKChkZXJpdmVLZXkpID0+IHsKICAgICAgICAgICAgICAgICAgICBzZXRSZW1vdGVEZXJpdmVLZXkoY29ubmVjdGlvbklkLCBrZXlJZCwgZGVyaXZlS2V5KTsKICAgICAgICAgICAgICAgIH0pOwogICAgICAgICAgICAgICAgZ2VuZXJhdGVXcml0ZUlWKG1hdGVyaWFsKS50aGVuKCh3cml0ZUlWKSA9PiB7CiAgICAgICAgICAgICAgICAgICAgc2V0V3JpdGVJVihjb25uZWN0aW9uSWQsIGtleUlkLCB3cml0ZUlWKTsKICAgICAgICAgICAgICAgIH0pOwogICAgICAgICAgICAgICAgc2V0TGF0ZXN0UmVtb3RlS2V5SWQoY29ubmVjdGlvbklkLCBrZXlJZCk7CiAgICAgICAgICAgIH0pOwogICAgICAgIH0KICAgIH0KICAgIGVsc2UgaWYgKHR5cGUgPT09ICJyZW1vdmVSZW1vdGVEZXJpdmVLZXkiKSB7CiAgICAgICAgY29uc3QgeyBjb25uZWN0aW9uSWQgfSA9IGV2ZW50LmRhdGE7CiAgICAgICAgcmVtb3ZlRGVyaXZlS2V5KGNvbm5lY3Rpb25JZCk7CiAgICB9CiAgICBlbHNlIGlmICh0eXBlID09PSAiZW5jcnlwdCIpIHsKICAgICAgICBjb25zdCB7IHJlYWRhYmxlU3RyZWFtLCB3cml0YWJsZVN0cmVhbSB9ID0gZXZlbnQuZGF0YTsKICAgICAgICBjb25zdCB0cmFuc2Zvcm1TdHJlYW0gPSBuZXcgVHJhbnNmb3JtU3RyZWFtKHsKICAgICAgICAgICAgdHJhbnNmb3JtOiBlbmNyeXB0RnVuY3Rpb24sCiAgICAgICAgfSk7CiAgICAgICAgcmVhZGFibGVTdHJlYW0ucGlwZVRocm91Z2godHJhbnNmb3JtU3RyZWFtKS5waXBlVG8od3JpdGFibGVTdHJlYW0pOwogICAgfQogICAgZWxzZSBpZiAodHlwZSA9PT0gImRlY3J5cHQiKSB7CiAgICAgICAgY29uc3QgeyByZWFkYWJsZVN0cmVhbSwgd3JpdGFibGVTdHJlYW0gfSA9IGV2ZW50LmRhdGE7CiAgICAgICAgY29uc3QgdHJhbnNmb3JtU3RyZWFtID0gbmV3IFRyYW5zZm9ybVN0cmVhbSh7CiAgICAgICAgICAgIHRyYW5zZm9ybTogZGVjcnlwdEZ1bmN0aW9uLAogICAgICAgIH0pOwogICAgICAgIHJlYWRhYmxlU3RyZWFtLnBpcGVUaHJvdWdoKHRyYW5zZm9ybVN0cmVhbSkucGlwZVRvKHdyaXRhYmxlU3RyZWFtKTsKICAgIH0KICAgIGVsc2UgaWYgKHR5cGUgPT09ICJjbGVhciIpIHsKICAgICAgICBjb3VudE1hcC5jbGVhcigpOwogICAgICAgIHdyaXRlSVZNYXAuY2xlYXIoKTsKICAgICAgICByZW1vdGVEZXJpdmVLZXlNYXAuY2xlYXIoKTsKICAgICAgICBzZWxmRGVyaXZlS2V5TWFwLmNsZWFyKCk7CiAgICB9Cn07Cg==");this.worker=new Worker(URL.createObjectURL(new Blob([b],{type:"application/javascript"}))),this.worker.onmessage=c=>{const{operation:a}=c.data;"disconnect"===a&&"function"==typeof this.onWorkerDisconnect&&this.onWorkerDisconnect()}}clearWorker(){this.worker&&this.worker.postMessage({type:"clear"})}terminateWorker(){this.worker&&this.worker.terminate()}async init(){if(!window.Go)throw new Error(`Failed to load module Go. window.Go is ${window.Go}.`);const d=new Go,{instance:a}=await WebAssembly.instantiateStreaming(fetch("wasm.wasm"),d.importObject);if(d.run(a),!window.e2ee)throw new Error(`Failed to load module e2ee. window.e2ee is ${window.e2ee}.`);const{preKeyBundle:b}=await window.e2ee.init();return b}setupSenderTransform(e){if(e.track){const a=e.createEncodedStreams(),b=a.readableStream||a.readable,c=a.writableStream||a.writable;if(!this.worker)throw new Error("Worker is null. Call startWorker in advance.");this.worker.postMessage({type:"encrypt",readableStream:b,writableStream:c},[b,c])}}setupReceiverTransform(e){const a=e.createEncodedStreams(),b=a.readableStream||a.readable,c=a.writableStream||a.writable;if(!this.worker)throw new Error("Worker is null. Call startWorker in advance.");this.worker.postMessage({type:"decrypt",readableStream:b,writableStream:c},[b,c])}postRemoteSecretKeyMaterials(b){if(!this.worker)throw new Error("Worker is null. Call startWorker in advance.");this.worker.postMessage({type:"remoteSecretKeyMaterials",remoteSecretKeyMaterials:b.remoteSecretKeyMaterials})}postSelfSecretKeyMaterial(e,a,b,c){if(!this.worker)throw new Error("Worker is null. Call startWorker in advance.");this.worker.postMessage({type:"selfSecretKeyMaterial",selfConnectionId:e,selfKeyId:a,selfSecretKeyMaterial:b,waitingTime:c})}startSession(e,a){const[b,c]=window.e2ee.startSession(e,a.identityKey,a.signedPreKey,a.preKeySignature);if(c)throw c;return b}stopSession(d){const[a,b]=window.e2ee.stopSession(d);if(b)throw b;return a}receiveMessage(d){const[a,b]=window.e2ee.receiveMessage(d);if(b)throw b;return a}start(d){const[a,b]=window.e2ee.start(d);if(b)throw b;return a}addPreKeyBundle(d,a){const b=window.e2ee.addPreKeyBundle(d,a.identityKey,a.signedPreKey,a.preKeySignature);if(b)throw b}selfFingerprint(){return window.e2ee.selfFingerprint()}remoteFingerprints(){return window.e2ee.remoteFingerprints()}static version(){return"2020.5.0-canary.0-dev"}static wasmVersion(){return window.e2ee.version()}}})});class j{constructor(a,b,c,d,e,f){this.role=b,this.channelId=c,this.metadata=d,this.signalingUrl=a,this.options=e,this.options.timeout===void 0&&(this.options.timeout=6e4),this.constraints=null,this.debug=f,this.clientId=null,this.connectionId=null,this.remoteConnectionIds=[],this.stream=null,this.ws=null,this.pc=null,this.callbacks={disconnect:()=>{},push:()=>{},addstream:()=>{},track:()=>{},removestream:()=>{},removetrack:()=>{},notify:()=>{},log:()=>{},timeout:()=>{}},this.authMetadata=null,this.e2ee=null}on(a,b){"addstream"===a?console.warn("@deprecated addstream callback will be removed in a future version. Use track callback."):"removestream"==a&&console.warn("@deprecated removestream callback will be removed in a future version. Use removetrack callback."),a in this.callbacks&&(this.callbacks[a]=b)}disconnect(){this.clientId=null,this.connectionId=null,this.authMetadata=null,this.remoteConnectionIds=[];const a=new Promise(a=>(this.debug&&console.warn("@deprecated closing MediaStream in disconnect will be removed in a future version. Close every track in the MediaStream by yourself."),!this.stream)?a():(this.stream.getTracks().forEach(a=>{a.stop()}),this.stream=null,a())),b=new Promise(a=>this.ws?(1===this.ws.readyState&&this.ws.send(JSON.stringify({type:"disconnect"})),this.ws.close(),this.ws=null,a()):a()),c=new Promise(a=>{if(!this.pc||"closed"===this.pc.connectionState||void 0===this.pc.connectionState)return a();let b=50;const c=setInterval(()=>this.pc?"closed"===this.pc.connectionState?(clearInterval(c),this.pc=null,a()):(--b,0>b)?(clearInterval(c),a()):void 0:(clearInterval(c),a()),100);this.pc.close()});return this.e2ee&&(this.e2ee.terminateWorker(),this.e2ee=null),Promise.all([a,b,c])}startE2EE(){"e2ee"in this.options&&"string"==typeof this.options.e2ee&&(this.e2ee=new i,this.e2ee.onWorkerDisconnect=()=>{this.disconnect()},this.e2ee.startWorker())}signaling(a){return this.trace("CREATE OFFER SDP",a),new Promise((b,c)=>{const d=e(a.sdp||"",this.role,this.channelId,this.metadata,this.options);null===this.ws&&(this.ws=new WebSocket(this.signalingUrl)),this.ws.onclose=a=>{const b=new Error;b.message=`Signaling failed. CloseEventCode:${a.code} CloseEventReason:'${a.reason}'`,c(b)},this.ws.onopen=()=>{this.trace("SIGNALING CONNECT MESSAGE",d),this.ws&&this.ws.send(JSON.stringify(d))},this.ws.onmessage=a=>{const c=JSON.parse(a.data);"offer"==c.type?(this.clientId=c.client_id,this.connectionId=c.connection_id,this.ws&&(this.ws.onclose=a=>{this.callbacks.disconnect(a),this.disconnect()},this.ws.onerror=null),"metadata"in c&&(this.authMetadata=c.metadata),this.trace("SIGNALING OFFER MESSAGE",c),this.trace("OFFER SDP",c.sdp),b(c)):"update"==c.type?(this.trace("UPDATE SDP",c.sdp),this.update(c)):"ping"==c.type?c.stats?this.getStats().then(a=>{this.ws&&this.ws.send(JSON.stringify({type:"pong",stats:a}))}):this.ws&&this.ws.send(JSON.stringify({type:"pong"})):"push"==c.type?this.callbacks.push(c):"notify"==c.type&&this.callbacks.notify(c)}})}async createOffer(){const a=new window.RTCPeerConnection({iceServers:[]});if(d()){a.addTransceiver("video",{direction:"recvonly"}),a.addTransceiver("audio",{direction:"recvonly"});const b=await a.createOffer();return a.close(),b}const b=await a.createOffer({offerToReceiveAudio:!0,offerToReceiveVideo:!0});return a.close(),b}async connectPeerConnection(a){const b=a.config||{};let c=b;if(this.e2ee&&(c.encodedInsertableStreams=!0),void 0!==window.RTCPeerConnection.generateCertificate){const a=await window.RTCPeerConnection.generateCertificate({name:"ECDSA",namedCurve:"P-256"});c=Object.assign({certificates:[a]},b)}return this.trace("PEER CONNECTION CONFIG",c),this.pc=new window.RTCPeerConnection(c,this.constraints),void(this.pc.oniceconnectionstatechange=()=>{this.pc&&this.trace("ONICECONNECTIONSTATECHANGE ICECONNECTIONSTATE",this.pc.iceConnectionState)})}async setRemoteDescription(a){this.pc&&(await this.pc.setRemoteDescription(new RTCSessionDescription({type:"offer",sdp:a.sdp})))}async createAnswer(a){if(this.pc){if(this.options.simulcast&&("upstream"===this.role||"sendrecv"===this.role||"sendonly"===this.role)&&a.encodings){const b=this.pc.getTransceivers().find(a=>{if(a.mid&&0<=a.mid.indexOf("video")&&null==a.currentDirection)return a});if(!b)throw new Error("Simulcast Error");await this.setSenderParameters(b,a.encodings),await this.setRemoteDescription(a),await this.setSenderParameters(b,a.encodings)}const b=await this.pc.createAnswer();await this.pc.setLocalDescription(b)}}sendAnswer(){this.pc&&this.ws&&this.pc.localDescription&&(this.trace("ANSWER SDP",this.pc.localDescription.sdp),this.ws.send(JSON.stringify({type:"answer",sdp:this.pc.localDescription.sdp})))}sendUpdateAnswer(){this.pc&&this.ws&&this.pc.localDescription&&(this.trace("ANSWER SDP",this.pc.localDescription.sdp),this.ws.send(JSON.stringify({type:"update",sdp:this.pc.localDescription.sdp})))}onIceCandidate(){return new Promise((a,b)=>{const c=setInterval(()=>{if(null===this.pc){clearInterval(c);const a=new Error;a.message="ICECANDIDATE TIMEOUT",b(a)}else this.pc&&"connected"===this.pc.iceConnectionState&&(clearInterval(c),a())},100);this.pc&&(this.pc.onicecandidate=b=>{if(this.pc&&this.trace("ONICECANDIDATE ICEGATHERINGSTATE",this.pc.iceGatheringState),null===b.candidate)clearInterval(c),a();else{const a=b.candidate.toJSON(),c=Object.assign(a,{type:"candidate"});this.trace("ONICECANDIDATE CANDIDATE MESSAGE",c),this.ws&&this.ws.send(JSON.stringify(c))}})})}waitChangeConnectionStateConnected(){return new Promise((a,b)=>{this.pc&&this.pc.connectionState===void 0&&a();const c=setInterval(()=>{if(!this.pc){const a=new Error;a.message="PeerConnection connectionState did not change to 'connected'",clearInterval(c),b(a)}else if(!this.ws||1!==this.ws.readyState){const a=new Error;a.message="PeerConnection connectionState did not change to 'connected'",clearInterval(c),b(a)}else this.pc&&"connected"===this.pc.connectionState&&(clearInterval(c),a())},100)})}setConnectionTimeout(){return new Promise((a,b)=>{this.options.timeout&&0<this.options.timeout&&setTimeout(()=>{if(this.pc&&"connected"!==this.pc.connectionState){const a=new Error;a.message="CONNECTION TIMEOUT",this.callbacks.timeout(),this.disconnect(),b(a)}},this.options.timeout)})}trace(a,b){this.callbacks.log(a,b);this.debug&&f(this.clientId,a,b)}async update(a){await this.setRemoteDescription(a),await this.createAnswer(a),this.sendUpdateAnswer()}setSenderParameters(a,b){const c=a.sender.getParameters();return c.encodings=b,a.sender.setParameters(c)}async getStats(){const a=[];if(!this.pc)return a;const b=await this.pc.getStats();return b.forEach(b=>{a.push(b)}),a}}class k extends j{async connect(a){return this.options.multistream?await Promise.race([this.multiStream(a),this.setConnectionTimeout()]):await Promise.race([this.singleStream(a),this.setConnectionTimeout()])}async singleStream(a){await this.disconnect(),this.startE2EE();const b=await this.createOffer(),c=await this.signaling(b);return await this.connectPeerConnection(c),await this.setRemoteDescription(c),a.getTracks().forEach(b=>{this.pc&&this.pc.addTrack(b,a)}),this.stream=a,await this.createAnswer(c),this.sendAnswer(),this.pc&&this.e2ee&&this.pc.getSenders().forEach(a=>{this.e2ee&&this.e2ee.setupSenderTransform(a)}),await this.onIceCandidate(),await this.waitChangeConnectionStateConnected(),a}async multiStream(a){await this.disconnect(),this.startE2EE();const b=await this.createOffer(),c=await this.signaling(b);return await this.connectPeerConnection(c),this.pc&&(this.pc.ontrack=a=>{const b=a.streams[0];b&&"default"!==b.id&&b.id!==this.connectionId&&(this.e2ee&&this.e2ee.setupReceiverTransform(a.receiver),this.callbacks.track(a),b.onremovetrack=a=>{if(this.callbacks.removetrack(a),a.target){const b=this.remoteConnectionIds.indexOf(a.target.id);-1<b&&(delete this.remoteConnectionIds[b],a.stream=a.target,this.callbacks.removestream(a))}},-1<this.remoteConnectionIds.indexOf(b.id)||(a.stream=b,this.remoteConnectionIds.push(b.id),this.callbacks.addstream(a)))}),await this.setRemoteDescription(c),a.getTracks().forEach(b=>{this.pc&&this.pc.addTrack(b,a)}),this.stream=a,await this.createAnswer(c),this.sendAnswer(),this.pc&&this.e2ee&&this.pc.getSenders().forEach(a=>{this.e2ee&&this.e2ee.setupSenderTransform(a)}),await this.onIceCandidate(),await this.waitChangeConnectionStateConnected(),a}}class l extends j{async connect(){return this.options.multistream?await Promise.race([this.multiStream(),this.setConnectionTimeout()]):await Promise.race([this.singleStream(),this.setConnectionTimeout()])}async singleStream(){await this.disconnect(),this.startE2EE();const a=await this.createOffer(),b=await this.signaling(a);return await this.connectPeerConnection(b),this.pc&&(this.pc.ontrack=a=>{this.stream=a.streams[0];const b=this.stream.id;"default"!==b&&(this.e2ee&&this.e2ee.setupReceiverTransform(a.receiver),this.callbacks.track(a),this.stream.onremovetrack=a=>{if(this.callbacks.removetrack(a),a.target){const b=this.remoteConnectionIds.indexOf(a.target.id);-1<b&&(delete this.remoteConnectionIds[b],a.stream=a.target,this.callbacks.removestream(a))}},-1<this.remoteConnectionIds.indexOf(b)||(a.stream=this.stream,this.remoteConnectionIds.push(b),this.callbacks.addstream(a)))}),await this.setRemoteDescription(b),await this.createAnswer(b),this.sendAnswer(),await this.onIceCandidate(),await this.waitChangeConnectionStateConnected(),this.stream||new MediaStream}async multiStream(){await this.disconnect(),this.startE2EE();const a=await this.createOffer(),b=await this.signaling(a);return await this.connectPeerConnection(b),this.pc&&(this.pc.ontrack=a=>{const b=a.streams[0];"default"!==b.id&&b.id!==this.connectionId&&(this.e2ee&&this.e2ee.setupReceiverTransform(a.receiver),this.callbacks.track(a),b.onremovetrack=a=>{if(this.callbacks.removetrack(a),a.target){const b=this.remoteConnectionIds.indexOf(a.target.id);-1<b&&(delete this.remoteConnectionIds[b],a.stream=a.target,this.callbacks.removestream(a))}},-1<this.remoteConnectionIds.indexOf(b.id)||(a.stream=b,this.remoteConnectionIds.push(b.id),this.callbacks.addstream(a)))}),await this.setRemoteDescription(b),await this.createAnswer(b),this.sendAnswer(),await this.onIceCandidate(),void(await this.waitChangeConnectionStateConnected())}}class m{constructor(a,b=!1){this.signalingUrl=a,this.debug=b}publisher(a,b=null,c={audio:!0,video:!0}){return console.warn("@deprecated publisher will be removed in a future version. Use sendrecv or sendonly."),new k(this.signalingUrl,"upstream",a,b,c,this.debug)}subscriber(a,b=null,c={audio:!0,video:!0}){return console.warn("@deprecated subscriber will be removed in a future version. Use recvonly."),new l(this.signalingUrl,"downstream",a,b,c,this.debug)}sendrecv(a,b=null,c={audio:!0,video:!0}){return new k(this.signalingUrl,"sendrecv",a,b,c,this.debug)}sendonly(a,b=null,c={audio:!0,video:!0}){return new k(this.signalingUrl,"sendonly",a,b,c,this.debug)}recvonly(a,b=null,c={audio:!0,video:!0}){return new l(this.signalingUrl,"recvonly",a,b,c,this.debug)}}return{connection:function(a,b=!1){return new m(a,b)},version:function(){return"2020.5.0-canary.0-dev"}}});
//# sourceMappingURL=sora.min.js.map
